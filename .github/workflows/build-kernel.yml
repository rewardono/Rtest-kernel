name: Build GKI Kernel for A135F - FINAL BOSS FIX
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu
      
      - name: Get Fresh Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
      
      - name: Fix ALL Compiler Flags
        run: |
          cd kernel
          
          echo "=== Fixing ALL compiler flag issues ==="
          
          # 1. Fix the unused variable
          sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c
          
          # 2. Fix the malformed -implicit-function-declaration flag
          echo "Fixing -implicit-function-declaration -> -Wimplicit-function-declaration..."
          
          # Search for this flag in all files
          grep -r "implicit-function-declaration" . 2>/dev/null | head -10 || true
          
          # Fix in all Makefiles
          find . -type f \( -name "Makefile*" -o -name "Kbuild*" -o -name "*.mk" \) \
            -exec sed -i 's/-implicit-function-declaration/-Wimplicit-function-declaration/g' {} \; 2>/dev/null || true
          
          # 3. Fix other potential malformed flags
          echo "Fixing other malformed flags..."
          
          # Common malformed flags pattern
          MALFORMED_FLAGS="implicit-function-declaration return-type missing-prototypes unused-but-set-variable"
          
          for flag in $MALFORMED_FLAGS; do
            # Fix -flag to -Wflag
            find . -type f \( -name "Makefile*" -o -name "Kbuild*" -o -name "*.mk" \) \
              -exec sed -i "s/-$flag/-W$flag/g" {} \; 2>/dev/null || true
            
            # Fix =flag to -Wflag
            find . -type f \( -name "Makefile*" -o -name "Kbuild*" -o -name "*.mk" \) \
              -exec sed -i "s/=$flag/-W$flag/g" {} \; 2>/dev/null || true
            
            # Fix =-Wflag to -Wflag
            find . -type f \( -name "Makefile*" -o -name "Kbuild*" -o -name "*.mk" \) \
              -exec sed -i "s/=-W$flag/-W$flag/g" {} \; 2>/dev/null || true
          done
          
          # 4. Remove all ccache references
          echo "Removing ccache references..."
          find . -type f \( -name "Makefile*" -o -name "Kbuild*" -o -name "*.mk" -o -name "*.sh" \) \
            -exec sed -i 's/ccache //g' {} \; 2>/dev/null || true
          
          # 5. Check the specific command that was failing
          echo "=== Checking the exact failing command ==="
          if [ -f "Makefile" ]; then
            echo "Looking for KBUILD_CFLAGS in Makefile:"
            grep -n "KBUILD_CFLAGS" Makefile | head -5
            
            echo "Looking for CFLAGS in arch/arm64/Makefile:"
            grep -n "CFLAGS" arch/arm64/Makefile 2>/dev/null | head -5 || true
          fi
      
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          git clone https://github.com/tiann/KernelSU --depth=1 ksu_tmp
          mv ksu_tmp/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          rm -rf ksu_tmp
      
      - name: Build Kernel with Direct Compiler Override
        run: |
          cd kernel
          
          # Clean everything
          make distclean 2>/dev/null || true
          rm -f .config
          
          # Set environment
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Configure
          echo "Configuring kernel..."
          make gki_defconfig
          
          # Enable KSU and modules
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
          
          # Save config
          cp .config .config.original
          
          echo "Starting build with direct compiler override..."
          
          # Build with specific override for the problematic flag
          # We'll use KCFLAGS to override the problematic flag
          export KCFLAGS="-Wno-error -Wno-implicit-function-declaration"
          
          # First, try to build the specific target that was failing
          echo "=== Testing kernel/bounds.s ==="
          make V=1 kernel/bounds.s 2>&1 | tee test_build.log
          
          if [ -f "kernel/bounds.s" ]; then
            echo "âœ… kernel/bounds.s built successfully!"
            
            # Now build everything
            echo "Building full kernel..."
            make -j$(nproc) 2>&1 | tee full_build.log
            
            if [ -f "arch/arm64/boot/Image" ]; then
              echo "ðŸŽ‰ KERNEL BUILD SUCCESSFUL!"
            else
              echo "âŒ Full build failed"
              tail -100 full_build.log
              exit 1
            fi
          else
            echo "âŒ kernel/bounds.s failed"
            
            # Try a different approach - edit the command directly
            echo "Trying manual fix..."
            
            # Find the exact command that was run
            echo "=== Last compiler command from log ==="
            grep "aarch64-linux-gnu-gcc.*bounds" test_build.log | tail -1
            
            # Try building with a wrapper script
            echo "Creating compiler wrapper to fix flags..."
            
            cat > /tmp/fixed_gcc << 'EOF'
#!/bin/bash
# Wrapper to fix malformed compiler flags
ARGS=()
for arg in "$@"; do
  # Fix -implicit-function-declaration to -Wimplicit-function-declaration
  if [ "$arg" = "-implicit-function-declaration" ]; then
    arg="-Wimplicit-function-declaration"
  fi
  # Fix other malformed flags
  if [[ "$arg" == "-"*=* ]]; then
    # Convert -flag=value to -flag=value (but check if it's malformed)
    arg=$(echo "$arg" | sed 's/^-\([^=]*\)=\(.*\)/-\1=\2/')
  fi
  ARGS+=("$arg")
done

# Call the real compiler
exec aarch64-linux-gnu-gcc "${ARGS[@]}"
EOF
            
            chmod +x /tmp/fixed_gcc
            
            # Try building with the wrapper
            export CC="/tmp/fixed_gcc"
            make clean
            make kernel/bounds.s 2>&1 | tail -50
            
            if [ -f "kernel/bounds.s" ]; then
              echo "âœ… Fixed with wrapper!"
              make -j$(nproc) 2>&1 | tee wrapper_build.log
            else
              echo "âŒ Wrapper also failed"
              exit 1
            fi
          fi
      
      - name: Alternative - Patch KBUILD_CFLAGS Directly
        if: failure()
        run: |
          cd kernel
          
          echo "Trying direct patch of KBUILD_CFLAGS..."
          
          # Find where the malformed flag is defined
          echo "Searching for flag definitions..."
          grep -r "implicit-function-declaration" . 2>/dev/null || true
          
          # Patch the main Makefile to remove problematic flags
          if [ -f "Makefile" ]; then
            echo "Patching Makefile KBUILD_CFLAGS..."
            
            # Backup
            cp Makefile Makefile.backup
            
            # Remove problematic flags from KBUILD_CFLAGS
            sed -i 's/ -implicit-function-declaration//g' Makefile
            sed -i 's/ -Werror-implicit-function-declaration//g' Makefile
            
            # Also check arch/arm64/Makefile
            if [ -f "arch/arm64/Makefile" ]; then
              sed -i 's/ -implicit-function-declaration//g' arch/arm64/Makefile
            fi
          fi
          
          # Clean and try again
          make distclean
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          make gki_defconfig
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
          
          echo "Building after direct patch..."
          make -j1 2>&1 | tail -100
      
      - name: Prepare Success Artifacts
        if: success()
        run: |
          cd kernel
          
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ FINAL SUCCESS! ðŸŽ‰ðŸŽ‰ðŸŽ‰"
            echo "Kernel built for Samsung A135F (GKI)"
            echo "File: arch/arm64/boot/Image"
            echo "Size: $(du -h arch/arm64/boot/Image | cut -f1)"
            
            mkdir -p artifacts
            cp arch/arm64/boot/Image artifacts/
            
            # Create success info
            cat > artifacts/SUCCESS.md << 'EOF'
            # CONGRATULATIONS!
            
            You have successfully built a GKI kernel for Samsung A135F!
            
            ## What you have:
            1. GKI kernel Image (Generic Kernel Image)
            2. KernelSU integrated
            3. For Exynos 850 chipset
            
            ## How to flash:
            
            ### Method 1: Using AnyKernel3
            1. Download AnyKernel3 template from: https://github.com/osm0sis/AnyKernel3
            2. Replace the Image file in the zip
            3. Flash via custom recovery (TWRP/OrangeFox)
            
            ### Method 2: Manual boot.img patching
            1. Extract boot.img from your stock firmware
            2. Use Android Image Kitchen (AIK) to unpack
            3. Replace the kernel with this Image file
            4. Repack and flash with Odin
            
            ## Important Notes:
            - This is a GKI kernel for a non-GKI device
            - Backup your current kernel first!
            - Have Odin ready in case of bootloop
            - Test basic functions after flashing
            
            ## Build Details:
            - Kernel version: 4.19.325
            - Platform: Android 13
            - Chipset: Exynos 850
            - Device: Samsung Galaxy A135F
            EOF
            
            echo "Artifacts ready:"
            ls -lh artifacts/
          else
            echo "âŒ No kernel Image found"
            exit 1
          fi
      
      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: A135F-GKI-KERNEL-FINAL
          path: kernel/artifacts/
          retention-days: 7
