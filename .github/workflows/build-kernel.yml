name: Build GKI Kernel - FINAL FIXES v2
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
      - name: ğŸ”§ Setup
        run: |
          sudo apt update
          sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev git wget gcc-aarch64-linux-gnu g++-aarch64-linux-gnu python3
          
          # Create working ccache
          echo '#!/bin/bash' | sudo tee /usr/bin/ccache
          echo 'exec "${@}"' | sudo tee -a /usr/bin/ccache
          sudo chmod +x /usr/bin/ccache

      - name: ğŸ“¥ Get Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1

      - name: ğŸ”¨ Apply ALL Fixes
        run: |
          cd kernel
          
          echo "=== APPLYING ALL FIXES ==="
          
          # 1. Fix sec_debug.h macro
          sed -i 's/#define secdbg_exin_get_unfz(a).*/#define secdbg_exin_get_unfz(a) ("")/' include/linux/sec_debug.h 2>/dev/null || true
          
          # 2. Fix process.c unused variable
          sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c 2>/dev/null || true
          
          # 3. Fix systrace_mark.h zero-length format string
          sed -i 's/systrace_mark_end()\s*__systrace_mark(SYSTRACE_MARK_TYPE_END, "")/systrace_mark_end()    __systrace_mark(SYSTRACE_MARK_TYPE_END, "end")/' include/trace/systrace_mark.h 2>/dev/null || true
          
          # 4. Fix ems.h unused functions - mark them with __maybe_unused
          if [ -f "include/linux/ems.h" ]; then
            echo "Fixing ems.h..."
            # Add __maybe_unused to all static functions in ems.h
            sed -i '/static.*{.*}/s/static \(.*\)/static __maybe_unused \1/' include/linux/ems.h 2>/dev/null || true
            # Remove the frt_limit_fast_cpu declaration
            sed -i '/static inline void frt_limit_fast_cpu/d' include/linux/ems.h 2>/dev/null || true
          fi
          
          # 5. Fix all compiler flags
          find . -type f \( -name "Makefile*" -o -name "Kbuild*" \) -exec sed -i \
            -e 's/-Werror-Wreturn-type/-Wreturn-type/g' \
            -e 's/-Werror-Wimplicit-function-declaration/-Wimplicit-function-declaration/g' \
            {} \; 2>/dev/null || true
          
          # 6. Remove ccache
          sed -i 's/ccache//g' Makefile 2>/dev/null || true
          sed -i 's/^HOSTCC\s*:=.*/HOSTCC = gcc/' Makefile 2>/dev/null || true
          
          echo "âœ… All fixes applied"

      - name: âš¡ Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          wget -q https://github.com/tiann/KernelSU/archive/main.tar.gz -O ksu.tar.gz
          tar -xzf ksu.tar.gz
          mv KernelSU-main/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          rm -rf KernelSU-main ksu.tar.gz

      - name: âš™ï¸ Configure
        run: |
          cd kernel
          rm -rf out
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export HOSTCC=gcc
          mkdir -p out
          make O=out ARCH=arm64 gki_defconfig
          echo "CONFIG_KSU=y" >> out/.config
          echo "CONFIG_MODULES=y" >> out/.config
          make O=out ARCH=arm64 olddefconfig

      - name: ğŸ› ï¸ Fix Generated Files
        run: |
          cd kernel
          # Fix generated Makefiles
          find out -type f -name "Makefile*" -exec sed -i \
            -e 's/-Werror-Wreturn-type/-Wreturn-type/g' \
            -e 's/-Werror-Wimplicit-function-declaration/-Wimplicit-function-declaration/g' \
            {} \; 2>/dev/null || true

      - name: ğŸ—ï¸ Build with NO WERROR
        run: |
          cd kernel
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export HOSTCC=gcc
          
          echo "ğŸš€ Building with KCFLAGS to disable Werror..."
          
          # Build with warnings disabled
          if make O=out ARCH=arm64 KCFLAGS="-Wno-error" -j$(nproc) 2>&1 | tee build.log; then
            echo "âœ… Build successful!"
          else
            echo "âš ï¸ Parallel failed, trying single core..."
            
            # Clean and try single core
            make O=out ARCH=arm64 clean 2>/dev/null || true
            
            if make O=out ARCH=arm64 KCFLAGS="-w" -j1 2>&1 | tee build_single.log; then
              echo "âœ… Single-core build successful!"
            else
              echo "âŒ Build failed"
              tail -100 build_single.log
              exit 1
            fi
          fi
          
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "ğŸ‰ğŸ‰ğŸ‰ KERNEL BUILT SUCCESSFULLY! ğŸ‰ğŸ‰ğŸ‰"
            ls -lh out/arch/arm64/boot/Image
          else
            echo "âŒ Kernel not found"
            exit 1
          fi

      - name: ğŸ“¦ Package
        if: success()
        run: |
          cd kernel
          mkdir -p anykernel
          cp out/arch/arm64/boot/Image anykernel/
          echo '#!/system/bin/sh' > anykernel/anykernel.sh
          echo 'echo "Flashing kernel..."' >> anykernel/anykernel.sh
          echo 'dd if=/tmp/anykernel/Image of=/dev/block/by-name/boot' >> anykernel/anykernel.sh
          chmod +x anykernel/anykernel.sh
          cd anykernel
          zip -r9 ../kernel.zip *

      - name: ğŸ“¤ Upload
        uses: actions/upload-artifact@v4
        with:
          name: kernel
          path: |
            kernel/out/arch/arm64/boot/Image
            kernel/kernel.zip
