name: Build GKI Kernel for Samsung A135F - SIMPLE
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
      # STEP 1: Install dependencies INCLUDING ccache
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            ccache \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu
          
          echo "✅ Dependencies installed (WITH ccache)"
      
      # STEP 2: Get kernel source
      - name: Get Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
          echo "✅ Kernel source cloned"
      
      # STEP 3: Fix ONLY the compilation errors (no ccache fixes needed)
      - name: Fix Compilation Issues
        run: |
          cd kernel
          
          # Fix the unused variable warning
          sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c
          
          # Fix malformed compiler flags
          sed -i 's/-implicit-function-declaration/-Wimplicit-function-declaration/g' Makefile 2>/dev/null || true
          sed -i 's/-Werror-Wimplicit-function-declaration/-Werror -Wimplicit-function-declaration/g' Makefile 2>/dev/null || true
          
          echo "✅ Compilation fixes applied"
      
      # STEP 4: Add KernelSU
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          git clone https://github.com/tiann/KernelSU --depth=1 ksu_tmp
          mv ksu_tmp/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          rm -rf ksu_tmp
          echo "✅ KernelSU added"
      
      # STEP 5: Configure and build
      - name: Build Kernel
        run: |
          cd kernel
          
          # Clean
          make distclean 2>/dev/null || true
          rm -f .config
          
          # Set environment
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Configure
          make gki_defconfig
          make olddefconfig
          
          # Enable KSU
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
          
          # Build
          echo "Building kernel..."
          make -j$(nproc) 2>&1 | tee build.log
          
          # Check result
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "✅ KERNEL BUILT SUCCESSFULLY!"
            echo "Size: $(du -h arch/arm64/boot/Image | cut -f1)"
          else
            echo "❌ Build failed"
            tail -100 build.log
            exit 1
          fi
      
      # STEP 6: Upload
      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: A135F-Kernel
          path: kernel/arch/arm64/boot/Image
          retention-days: 7
