name: Build Kernel - Complete Fixes
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Setup Environment
      run: |
        sudo apt update
        sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev git wget gcc-aarch64-linux-gnu g++-aarch64-linux-gnu python3 ccache
        sudo ln -s /usr/bin/ccache /usr/local/bin/ccache || true

    - name: Get Kernel Source
      run: |
        rm -rf kernel
        git clone https://github.com/samsungexynos850/atlas kernel --depth=1

    - name: Apply Comprehensive Fixes
      run: |
        cd kernel
        
        echo "=== Applying all necessary fixes ==="
        
        # 1. Fix bpf_trace.c - remove 'inline' from variable argument function
        echo "Fixing bpf_trace.c..."
        sed -i 's/static inline __printf(1, 0) int bpf_do_trace_printk/static __printf(1, 0) int bpf_do_trace_printk/' kernel/trace/bpf_trace.c 2>/dev/null || true
        # Alternative approach: change to noinline
        sed -i 's/static inline __printf(1, 0)/static __noinline __printf(1, 0)/' kernel/trace/bpf_trace.c 2>/dev/null || true
        
        # 2. Fix sec_debug.h
        echo "Fixing sec_debug.h..."
        sed -i 's|#define secdbg_exin_get_unfz(.*).*|#define secdbg_exin_get_unfz(a) ("")|' include/linux/sec_debug.h 2>/dev/null || true
        
        # 3. Fix EMS header conflicts - COMPLETE SOLUTION
        echo "Fixing EMS headers..."
        if [ -f "include/linux/ems.h" ]; then
          # Check what's actually in the file
          EMS_LINE=$(grep -n "lb_cfs_tasks" include/linux/ems.h | head -1 | cut -d: -f1)
          if [ ! -z "$EMS_LINE" ]; then
            # Get the exact line and fix it
            sed -i "${EMS_LINE}s/.*/extern struct list_head *lb_cfs_tasks(struct rq *rq, int sse);/" include/linux/ems.h
          fi
        fi
        
        # 4. Fix lb_cfs_tasks implementation in load_balance.c
        echo "Fixing load_balance.c..."
        if [ -f "kernel/sched/ems/load_balance.c" ]; then
          # Match the header declaration
          sed -i 's/struct list_head \*lb_cfs_tasks(struct rq \*rq, struct sched_entity \*se)/struct list_head *lb_cfs_tasks(struct rq *rq, int sse)/' kernel/sched/ems/load_balance.c 2>/dev/null || true
        fi
        
        # 5. Fix lb_cfs_tasks in fair.c - REMOVE our added function
        echo "Fixing fair.c..."
        if [ -f "kernel/sched/fair.c" ]; then
          # Remove the problematic line we added
          sed -i '/static inline struct list_head \*lb_cfs_tasks.*{ return \&rq->cfs_tasks; }/d' kernel/sched/fair.c 2>/dev/null || true
        fi
        
        # 6. Fix need_memory_boosting COMPLETELY
        echo "Fixing need_memory_boosting..."
        # First, make sure we have the right declaration in mm.h
        if grep -q "need_memory_boosting" include/linux/mm.h 2>/dev/null; then
          sed -i '/need_memory_boosting/s/.*/#ifndef need_memory_boosting\nstatic inline bool need_memory_boosting(void) { return false; }\n#endif/' include/linux/mm.h 2>/dev/null || true
        else
          # Add it if not present
          echo -e "\n#ifndef need_memory_boothing\nstatic inline bool need_memory_boosting(void) { return false; }\n#endif" >> include/linux/mm.h
        fi
        
        # Then comment out the definition in vmscan.c
        if [ -f "mm/vmscan.c" ]; then
          # Find the function and comment it out
          sed -i '/^inline bool need_memory_boosting(void)/,/^}/s/^/\/\//' mm/vmscan.c 2>/dev/null || true
          # Alternative: rename it to avoid conflict
          sed -i 's/^inline bool need_memory_boosting(void)/static inline bool __need_memory_boosting(void)/' mm/vmscan.c 2>/dev/null || true
        fi
        
        # 7. Fix compiler warnings
        echo "Fixing compiler flags..."
        find . -type f -name "Makefile*" -exec sed -i \
          -e 's/-Werror-/-Wno-error -W/g' \
          -e 's/-Werror=/-Wno-error -W/g' \
          -e 's/-Werror\b//g' \
          {} \; 2>/dev/null || true
        
        # 8. Fix process.c unused variable
        sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused *sys_state[SYSTEM_END] = {/' kernel/power/process.c 2>/dev/null || true
        
        # 9. Fix systrace_mark.h
        sed -i 's|systrace_mark_end()\s*__systrace_mark(SYSTRACE_MARK_TYPE_END, "")|systrace_mark_end()    __systrace_mark(SYSTRACE_MARK_TYPE_END, "end")|' include/trace/systrace_mark.h 2>/dev/null || true
        
        echo "âœ… All fixes applied"

    - name: Add KernelSU
      run: |
        cd kernel
        rm -rf drivers/kernelsu
        git clone https://github.com/tiann/KernelSU ksu_tmp --depth=1
        mv ksu_tmp/kernel drivers/kernelsu
        echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
        echo 'obj-y += kernelsu/' >> drivers/Makefile
        rm -rf ksu_tmp

    - name: Configure Kernel
      run: |
        cd kernel
        rm -rf out
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        mkdir -p out
        # Use gki_defconfig for GKI build
        make O=out ARCH=arm64 gki_defconfig
        
        # Enable KernelSU and disable module signing
        ./scripts/config --file out/.config --enable KSU
        ./scripts/config --file out/.config --set-str KSU_GIT_VERSION "github-action-build"
        ./scripts/config --file out/.config --disable MODULE_SIG
        ./scripts/config --file out/.config --disable MODULE_SIG_ALL
        ./scripts/config --file out/.config --disable MODULE_SIG_FORCE
        
        # Disable problematic Samsung debug features
        ./scripts/config --file out/.config --disable SEC_DEBUG
        ./scripts/config --file out/.config --disable SEC_DEBUG_EXTRA_INFO
        
        make O=out ARCH=arm64 olddefconfig

    - name: Build Kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export KCFLAGS="-w -Wno-error -Wno-error=attribute-alias -Wno-error=implicit-function-declaration -Wno-error=incompatible-pointer-types"
        
        echo "ğŸš€ Starting kernel build..."
        
        # Try parallel build first
        if make O=out ARCH=arm64 -j$(nproc) 2>&1 | tee build.log; then
          echo "âœ… Parallel build successful!"
        else
          echo "âš ï¸ Parallel build failed, checking for specific errors..."
          
          # Show error summary
          echo "=== BUILD ERROR SUMMARY ==="
          grep -i "error:" build.log | head -20
          
          echo "âš ï¸ Trying single-core build..."
          make O=out ARCH=arm64 clean 2>/dev/null || true
          
          if make O=out ARCH=arm64 -j1 2>&1 | tee build_single.log; then
            echo "âœ… Single-core build successful!"
          else
            echo "âŒ Build failed with single core"
            echo "=== LAST 50 LINES OF ERRORS ==="
            tail -50 build_single.log | grep -i "error:" || tail -50 build_single.log
            exit 1
          fi
        fi
        
        # Verify kernel image exists
        if [ -f "out/arch/arm64/boot/Image" ]; then
          echo "ğŸ‰ğŸ‰ğŸ‰ KERNEL BUILD SUCCESSFUL! ğŸ‰ğŸ‰ğŸ‰"
          ls -lh out/arch/arm64/boot/Image
          echo "Size: $(wc -c < out/arch/arm64/boot/Image) bytes"
        else
          echo "âŒ Kernel Image not found!"
          echo "Checking for alternative output..."
          find out -name "Image" -o -name "Image.gz" | head -10
          exit 1
        fi

    - name: Create AnyKernel3 Package
      if: success()
      run: |
        cd kernel
        # Download AnyKernel3 template
        wget -q https://github.com/osm0sis/AnyKernel3/archive/master.zip -O anykernel.zip
        unzip -q anykernel.zip -d anykernel_temp
        mv anykernel_temp/AnyKernel3-master anykernel
        rm -rf anykernel_temp anykernel.zip
        
        # Copy kernel image
        cp out/arch/arm64/boot/Image anykernel/
        
        # Create basic anykernel script
        cat > anykernel/anykernel.sh << 'EOF'
        #!/system/bin/sh
        # AnyKernel3 Ramdisk Mod Script
        # osm0sis @ xda-developers
        
        ## AnyKernel setup
        # begin properties
        properties() {
        kernel.string=Atlas-GKI-Kernel
        do.devicecheck=1
        do.modules=0
        do.systemless=1
        do.cleanup=1
        do.cleanuponabort=0
        device.name1=a13
        device.name2=a135f
        device.name3=exynos850
        }
        
        # shell variables
        block=/dev/block/by-name/boot;
        is_slot_device=0;
        ramdisk_compression=auto;
        
        ## AnyKernel methods (DO NOT CHANGE)
        # import patching functions/variables - see for reference
        . tools/ak3-core.sh;
        
        ## AnyKernel install
        dump_boot;
        
        write_boot;
        ## end install
        EOF
        
        chmod +x anykernel/anykernel.sh
        
        # Create zip
        cd anykernel
        zip -r9 ../Atlas-GKI-Kernel-$(date +%Y%m%d).zip .

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: |
          kernel/out/arch/arm64/boot/Image
          kernel/Atlas-GKI-Kernel-*.zip

    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          kernel/build.log
          kernel/build_single.log
          kernel/out/.config
