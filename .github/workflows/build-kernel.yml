name: Build GKI Kernel for A135F
on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Clean build (takes longer)'
        required: false
        default: 'false'
jobs:
  build:
    runs-on: ubuntu-22.04  # Use specific version instead of latest
    timeout-minutes: 60  # Timeout after 60 minutes
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Dependencies (Minimum)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            gcc-aarch64-linux-gnu
          # Clean apt cache to save space
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
      
      - name: Clone Kernel Source (Shallow)
        run: |
          git clone --depth=1 --single-branch \
            https://github.com/samsungexynos850/atlas kernel
      
      - name: Add KernelSU (Minimal)
        run: |
          cd kernel
          git clone --depth=1 https://github.com/tiann/KernelSU ksu_tmp
          mv ksu_tmp/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          rm -rf ksu_tmp
      
      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Disable ccache to save space
          export USE_CCACHE=0
          
          mkdir -p out
          
          # Build with minimal output
          echo "Configuring kernel..."
          make O=out ARCH=arm64 gki_defconfig > /dev/null 2>&1
          
          # Enable KSU
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' out/.config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' out/.config
          
          echo "Building kernel (this may take a while)..."
          make O=out ARCH=arm64 -j2 2>&1 | tail -100
      
      - name: Upload Kernel
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: kernel/out/arch/arm64/boot/Image
          retention-days: 1  # Keep only 1 day to save space
