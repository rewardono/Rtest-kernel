name: Build GKI Kernel for A135F - ULTIMATE FIX
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    steps:
      - name: Install Everything (including ccache)
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            ccache  # â† MUST INSTALL CCACHE
          
          # Create symlink for "cache" command (the typo)
          sudo ln -sf /usr/bin/ccache /usr/local/bin/cache
          sudo ln -sf /usr/bin/ccache /usr/bin/cache
          
          # Verify
          which ccache
          which cache
          cache --version
      
      - name: Get Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
      
      - name: Apply ALL Fixes at Once
        run: |
          cd kernel
          
          # 1. Fix the unused variable
          sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c
          
          # 2. Patch ALL Makefiles to fix ccache issues
          echo "Patching Makefiles..."
          
          # Main Makefile patches
          sed -i 's/^[[:space:]]*cache[[:space:]]/ccache /g' Makefile
          sed -i 's/"cache"/"ccache"/g' Makefile
          
          # Patch scripts/Makefile.host (where the error occurs)
          if [ -f "scripts/Makefile.host" ]; then
            sed -i 's/^[[:space:]]*cache[[:space:]]/ccache /g' scripts/Makefile.host
            sed -i 's/"cache"/"ccache"/g' scripts/Makefile.host
            sed -i 's/$(cache)/$(ccache)/g' scripts/Makefile.host
          fi
          
          # Remove problematic Wno-error flags
          sed -i 's/-Wno-error-implicit-function-declaration//g' Makefile
          sed -i 's/-Wno-error//g' Makefile
          
          # Disable Werror completely
          sed -i 's/-Werror//g' Makefile
          sed -i 's/WERROR.*=.*1/WERROR = 0/g' Makefile
          
          # Also patch other common locations
          find . -name "Makefile*" -type f -exec sed -i 's/ cache / ccache /g' {} \; 2>/dev/null || true
          find . -name "Makefile*" -type f -exec sed -i 's/"cache"/"ccache"/g' {} \; 2>/dev/null || true
          
          echo "All patches applied!"
      
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          
          # Download KernelSU directly
          curl -L https://codeload.github.com/tiann/KernelSU/tar.gz/refs/heads/main | tar -xz
          mv KernelSU-main/kernel drivers/kernelsu
          
          # Add to build system
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          
          rm -rf KernelSU-main
      
      - name: Build with CCACHE Enabled
        run: |
          cd kernel
          
          # Clean everything
          make distclean 2>/dev/null || true
          rm -f .config
          
          # Set environment WITH ccache enabled
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export USE_CCACHE=1
          export CCACHE_DIR=/tmp/ccache
          mkdir -p $CCACHE_DIR
          
          # Make sure cache/ccache are in PATH
          export PATH="/usr/lib/ccache:$PATH"
          
          echo "Configuring kernel..."
          make gki_defconfig
          
          # Enable KSU
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
          
          # Save config
          cp .config .config.original
          
          echo "Building kernel (this will take 10-15 minutes)..."
          
          # First pass build
          if make -j$(nproc) 2>&1 | tee build.log; then
            echo "âœ… Build successful on first attempt!"
          else
            echo "âš ï¸ First attempt failed, trying with specific fixes..."
            
            # If failed, try with single core and debug
            make clean
            
            # Remove any remaining problematic flags
            grep -r "Wno-error" . 2>/dev/null | head -5
            
            # Try again with single core for clear errors
            make -j1 2>&1 | tee build_single.log
            
            if [ -f "arch/arm64/boot/Image" ]; then
              echo "âœ… Build successful on second attempt!"
            else
              echo "âŒ Build failed. Last 50 lines:"
              tail -50 build_single.log
              exit 1
            fi
          fi
          
          # Verify kernel exists
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "ğŸ‰ KERNEL BUILT SUCCESSFULLY!"
            ls -lh arch/arm64/boot/Image
            echo "Size: $(du -h arch/arm64/boot/Image | cut -f1)"
          else
            echo "âŒ No kernel Image found"
            exit 1
          fi
      
      - name: Create AnyKernel3 Package
        run: |
          cd kernel
          
          echo "Creating flashable package..."
          
          # Download AnyKernel3
          wget -q https://github.com/osm0sis/AnyKernel3/archive/refs/heads/master.zip
          unzip -q master.zip
          cd AnyKernel3-master
          
          # Copy our kernel
          cp ../arch/arm64/boot/Image .
          
          # Customize anykernel.sh for A135F
          cat > anykernel.sh << 'EOF'
          #!/system/bin/sh
          # AnyKernel3 Ramdisk Mod Script
          # osm0sis @ xda-developers
          
          ## AnyKernel setup
          # begin properties
          properties() {
            kernel.string=GKI Kernel for A135F with KernelSU
            do.devicecheck=1
            do.modules=0
            do.systemless=1
            do.cleanup=1
            do.cleanuponabort=0
            device.name1=a13
            device.name2=a135f
            device.name3=a13x
          }
          
          ## AnyKernel install
          dump_boot;
          write_boot;
          ## end install
          EOF
          
          # Create zip
          zip -r9 A135F-GKI-Kernel.zip *
          
          # Move to parent directory
          mv A135F-GKI-Kernel.zip ../../
          cd ..
          
          echo "Flashable zip created!"
          ls -lh ../A135F-GKI-Kernel.zip
      
      - name: Upload All Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: A135F-Kernel-COMPLETE
          path: |
            kernel/arch/arm64/boot/Image
            kernel/.config.original
            kernel/build.log
            A135F-GKI-Kernel.zip
          retention-days: 7
