name: Build GKI Kernel for A135F (Fixed)
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            ccache \
            wget \
            unzip
            
          # Install proper ARM64 cross-compiler
          sudo apt install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          
          # Also install clang for better compatibility
          sudo apt install -y clang llvm lld
      
      - name: Get Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
      
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          wget -q https://github.com/tiann/KernelSU/archive/refs/heads/main.zip -O ksu.zip
          unzip -q ksu.zip
          mv KernelSU-main/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          rm -rf KernelSU-main ksu.zip
      
      - name: Build Kernel
        run: |
          cd kernel
          
          # Try different toolchain approaches
          
          # APPROACH 1: Use GCC cross-compiler
          echo "=== Approach 1: Using GCC cross-compiler ==="
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Clean any previous builds
          make distclean 2>/dev/null || true
          
          # Configure
          make gki_defconfig
          
          # Enable KSU
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
          
          # Try to build
          if make -j2 2>&1 | tee build_gcc.log; then
            echo "GCC build successful!"
            BUILD_METHOD="gcc"
            cp arch/arm64/boot/Image kernel-Image
          else
            echo "GCC build failed, trying CLANG..."
            
            # APPROACH 2: Use CLANG
            make distclean 2>/dev/null || true
            make gki_defconfig
            sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
            sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
            
            export LLVM=1
            export LLVM_IAS=1
            export CLANG_TRIPLE=aarch64-linux-gnu-
            export CROSS_COMPILE=aarch64-linux-gnu-
            
            if make CC=clang LD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip -j2 2>&1 | tee build_clang.log; then
              echo "CLANG build successful!"
              BUILD_METHOD="clang"
              cp arch/arm64/boot/Image kernel-Image
            else
              echo "Both GCC and CLANG failed"
              echo "=== GCC build errors ==="
              grep -i "error\|fail" build_gcc.log | head -20
              echo "=== CLANG build errors ==="
              grep -i "error\|fail" build_clang.log | head -20
              exit 1
            fi
          fi
      
      - name: Check and Prepare Artifacts
        run: |
          cd kernel
          
          if [ -f "kernel-Image" ]; then
            echo "✓ Kernel build successful!"
            echo "Build method: $BUILD_METHOD"
            ls -lh kernel-Image
            
            # Create artifacts directory
            mkdir -p artifacts
            cp kernel-Image artifacts/
            
            # Also try to compress it
            gzip -k -f kernel-Image
            cp kernel-Image.gz artifacts/ 2>/dev/null || true
            
            echo "Files in artifacts directory:"
            ls -lh artifacts/
          else
            echo "✗ No kernel Image found"
            echo "Looking for build logs..."
            ls -la build_*.log 2>/dev/null || echo "No build logs found"
            exit 1
          fi
      
      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: A135F-GKI-Kernel-Image
          path: kernel/artifacts/
          retention-days: 7
