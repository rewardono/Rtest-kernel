name: Build Exynos850 Kernel (Stable Baseline)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          git wget unzip python3 ccache

    - name: Clone kernel source
      run: |
        git clone https://github.com/samsungexynos850/atlas kernel --depth=1

    - name: Add KernelSU
      run: |
        cd kernel
        git clone https://github.com/tiann/KernelSU --depth=1 kernelsu
        ln -s kernelsu/kernel drivers/kernelsu
        echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
        echo 'obj-y += kernelsu/' >> drivers/Makefile

    - name: Configure kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        make exynos850-atlas_defconfig

        scripts/config --enable KSU
        scripts/config --disable MODULE_SIG
        scripts/config --disable MODULE_SIG_ALL
        scripts/config --disable MODULE_SIG_FORCE

        scripts/config --enable KALLSYMS
        scripts/config --enable BPF
        scripts/config --enable BPF_SYSCALL
        scripts/config --enable CGROUPS

        make olddefconfig

    - name: Build kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        make -j$(nproc)

    - name: Package AnyKernel3
      run: |
        cd kernel
        wget -q https://github.com/osm0sis/AnyKernel3/archive/master.zip
        unzip -q master.zip
        mv AnyKernel3-master anykernel

        cp arch/arm64/boot/Image anykernel/

        cat > anykernel/anykernel.sh << 'EOF'
        #!/system/bin/sh
        properties() {
          kernel.string=Exynos850-KernelSU
          do.devicecheck=1
          do.systemless=1
          device.name1=a135f
        }
        block=/dev/block/by-name/boot
        is_slot_device=0
        . tools/ak3-core.sh
        dump_boot
        write_boot
        EOF

        chmod +x anykernel/anykernel.sh
        cd anykernel
        zip -r9 ../Exynos850-KernelSU.zip .

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel
        path: |
          kernel/arch/arm64/boot/Image
          kernel/Exynos850-KernelSU.zip
