name: Atlas Kernel - EMS Type Fix
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Setup Environment
      run: |
        sudo apt update
        sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev git wget gcc-aarch64-linux-gnu g++-aarch64-linux-gnu python3 ccache
        sudo ln -s /usr/bin/ccache /usr/local/bin/ccache || true

    - name: Get Kernel Source
      run: |
        git clone https://github.com/samsungexynos850/atlas kernel --depth=1

    - name: Surgical Code Fixes
      run: |
        cd kernel
        # 1. Fix bpf_trace.c (Remove 'inline' from variadic function)
        sed -i 's/static inline __printf(1, 0) int bpf_do_trace_printk/static __printf(1, 0) int bpf_do_trace_printk/g' kernel/trace/bpf_trace.c
        
        # 2. Fix lb_cfs_tasks (Match the EMS 'int' signature)
        # We inject a version that returns the standard cfs_tasks list to prevent null pointer dereferences
        sed -i '1i struct rq; static inline struct list_head *lb_cfs_tasks(struct rq *rq, int sse) { return &rq->cfs_tasks; }' kernel/sched/fair.c
        
        # 3. Fix need_memory_boosting (Provide a full body in the header)
        sed -i 's/extern inline bool need_memory_boosting(void);/static inline bool need_memory_boosting(void) { return false; }/g' include/linux/mm.h

        # 4. FIX COMPILER FLAGS (The 'Warning instead of Error' approach)
        find . -type f -name "Makefile*" -exec sed -i 's/-Werror-/-W/g' {} +
        find . -type f -name "Makefile*" -exec sed -i 's/-Werror=/-W/g' {} +
        find . -type f -name "Makefile*" -exec sed -i 's/-Werror\b//g' {} +

        # 5. Samsung-specific include error fix
        sed -i 's|#define secdbg_exin_get_unfz(a).*|#define secdbg_exin_get_unfz(a) ("")|' include/linux/sec_debug.h || true

    - name: Integrate KernelSU
      run: |
        cd kernel
        rm -rf drivers/kernelsu
        git clone https://github.com/tiann/KernelSU ksu_tmp
        mv ksu_tmp/kernel drivers/kernelsu
        sed -i '1i source "drivers/kernelsu/Kconfig"' drivers/Kconfig
        sed -i '1i obj-y += kernelsu/' drivers/Makefile
        rm -rf ksu_tmp

    - name: Build Kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export KCFLAGS="-w -Wno-error"
        mkdir -p out

        CONF_NAME=$(ls arch/arm64/configs/ | grep -E 'a13|3830|exynos850' | head -n 1)
        
        make O=out ARCH=arm64 $CONF_NAME
        
        # Configure KSU and Disable problematic debugs
        scripts/config --file out/.config --enable KSU
        scripts/config --file out/.config --disable MODULE_SIG
        scripts/config --file out/.config --disable MODULE_SIG_ALL
        scripts/config --file out/.config --disable SEC_DEBUG
        
        make O=out ARCH=arm64 olddefconfig
        make O=out ARCH=arm64 -j$(nproc)

    - name: Upload Kernel
      uses: actions/upload-artifact@v4
      with:
        name: Atlas-A135F-Final
        path: kernel/out/arch/arm64/boot/Image
