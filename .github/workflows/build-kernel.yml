name: Build Atlas Kernel (A135F)
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
      
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y git-core flex bison build-essential libssl-dev clang llvm lld bc libelf-dev ccache
          # Also install cross-compilation tools
          sudo apt install -y gcc-aarch64-linux-gnu
      
      - name: Clone Source
        run: |
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
      
      - name: Manual KernelSU Integration
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          git clone https://github.com/tiann/KernelSU ksu_tmp --depth=1
          mv ksu_tmp/kernel drivers/kernelsu
          sed -i '1i source "drivers/kernelsu/Kconfig"' drivers/Kconfig
          sed -i '1i obj-y += kernelsu/' drivers/Makefile
          rm -rf ksu_tmp
      
      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export LLVM=1
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Set PATH to include ccache if needed
          export PATH="/usr/lib/ccache:$PATH"
          
          mkdir -p out
          make O=out ARCH=arm64 exynos850_defconfig
          
          # Force enable KSU in the final config
          ./scripts/config --file out/.config --enable KSU
          # Disable module signing
          ./scripts/config --file out/.config --disable MODULE_SIG
          
          # Build the kernel with verbose output
          make O=out ARCH=arm64 -j$(nproc --all) 2>&1 | tee build.log
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Atlas-A135F-Kernel
          path: |
            kernel/out/arch/arm64/boot/Image
            kernel/build.log
