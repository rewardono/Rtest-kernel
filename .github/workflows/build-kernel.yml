name: Build GKI Kernel for Samsung A135F - FLAG FIX
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      # STEP 1: Install dependencies
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            wget \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu
          
          # Remove ccache completely
          sudo apt remove --purge -y ccache 2>/dev/null || true
          sudo rm -f /usr/local/bin/ccache /usr/local/bin/cache 2>/dev/null || true

      # STEP 2: Get kernel source
      - name: Get Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
          echo "âœ… Kernel source cloned"

      # STEP 3: TARGETED FIX for the compiler flag issue
      - name: Apply Targeted Fixes
        run: |
          cd kernel
          
          echo "=== APPLYING TARGETED FIXES ==="
          
          # FIX 1: Fix the specific compiler flag error
          echo "Fixing compiler flags..."
          
          # Fix the malformed flag: -Werror-Wreturn-type â†’ -Werror -Wreturn-type
          # Also fix similar patterns
          
          # Method 1: Search and replace in ALL Makefiles
          find . -type f \( -name "Makefile*" -o -name "Kbuild*" -o -name "*.mk" \) -exec grep -l "Werror-W" {} \; 2>/dev/null | while read file; do
            echo "Fixing flags in: $file"
            sed -i \
              -e 's/-Werror-Wreturn-type/-Werror -Wreturn-type/g' \
              -e 's/-Werror-Wimplicit-function-declaration/-Werror -Wimplicit-function-declaration/g' \
              -e 's/-Werror-implicit-function-declaration/-Werror -Wimplicit-function-declaration/g' \
              -e 's/-Werror-W/-Werror -W/g' \
              -e 's/-implicit-function-declaration/-Wimplicit-function-declaration/g' \
              -e 's/=return-type/-Wreturn-type/g' \
              "$file"
          done
          
          # FIX 2: Also check and fix KBUILD_CFLAGS in the root Makefile
          if [ -f "Makefile" ]; then
            echo "Fixing root Makefile..."
            # Look for KBUILD_CFLAGS and fix the flag
            sed -i 's/KBUILD_CFLAGS\s*+=.*-Werror-Wreturn-type/KBUILD_CFLAGS += -Werror -Wreturn-type/' Makefile
            sed -i 's/KBUILD_CFLAGS\s*+=.*-Werror-Wimplicit/KBUILD_CFLAGS += -Werror -Wimplicit-function-declaration/' Makefile
          fi
          
          # FIX 3: The original unused variable fix
          if [ -f "kernel/power/process.c" ]; then
            sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c
          fi
          
          # FIX 4: Disable Werror entirely if needed (last resort)
          echo "Optionally disabling Werror..."
          find . -type f -name "Makefile*" -exec sed -i 's/-Werror//g' {} \; 2>/dev/null || true
          
          echo "âœ… Fixes applied"

      # STEP 4: Add KernelSU
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          
          wget -q https://github.com/tiann/KernelSU/archive/main.tar.gz -O ksu.tar.gz
          tar -xzf ksu.tar.gz
          mv KernelSU-main/kernel drivers/kernelsu
          
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          
          rm -rf KernelSU-main ksu.tar.gz
          echo "âœ… KernelSU added"

      # STEP 5: Configure with simple method
      - name: Configure Kernel
        run: |
          cd kernel
          
          # Clean
          rm -rf out 2>/dev/null || true
          
          # Export environment
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export HOSTCC=gcc
          export HOSTCXX=g++
          
          mkdir -p out
          
          # First config
          make O=out ARCH=arm64 gki_defconfig 2>&1 | tee config_step1.log
          
          # Enable KernelSU and modules
          echo "CONFIG_KSU=y" >> out/.config
          echo "CONFIG_MODULES=y" >> out/.config
          
          # Update config
          make O=out ARCH=arm64 olddefconfig 2>&1 | tee config_step2.log
          
          echo "âœ… Configuration done"

      # STEP 6: DEBUG - Check what flags are being used
      - name: Debug Check Flags
        run: |
          cd kernel
          
          echo "=== DEBUG: Checking compiler flags ==="
          
          # Check root Makefile
          echo "Root Makefile KBUILD_CFLAGS:"
          grep -A5 -B5 "KBUILD_CFLAGS" Makefile | head -20 || true
          
          # Check for the problematic flag
          echo "Searching for -Werror-W flags:"
          find . -type f -name "Makefile*" -o -name "Kbuild*" | xargs grep -l "Werror-W" 2>/dev/null | head -5 || true
          
          # Check generated Makefile in out directory
          if [ -f "out/Makefile" ]; then
            echo "Generated Makefile KBUILD_CFLAGS:"
            grep -A3 -B3 "KBUILD_CFLAGS" out/Makefile | head -10 || true
          fi

      # STEP 7: Build with a SIMPLE DIRECT approach
      - name: Build Kernel (Direct Method)
        run: |
          cd kernel
          
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export HOSTCC=gcc
          export HOSTCXX=g++
          
          echo "ðŸš€ Starting build..."
          
          # OPTION 1: Try to build just the Image target
          echo "=== Building Image target ==="
          if make O=out ARCH=arm64 Image 2>&1 | tee build_image.log; then
            echo "âœ… Image built successfully!"
          else
            echo "âš ï¸ Direct Image build failed, trying alternative..."
            
            # Show the exact error
            tail -20 build_image.log
            
            # OPTION 2: Build with explicit flag override
            echo "=== Building with explicit CFLAGS override ==="
            
            # Clean intermediate files
            make O=out ARCH=arm64 clean 2>/dev/null || true
            
            # Try building with filtered flags
            make O=out ARCH=arm64 CFLAGS_KERNEL="-Wno-error" 2>&1 | tee build_override.log || {
              echo "âŒ Build failed with CFLAGS override"
              
              # OPTION 3: Build step by step
              echo "=== Building step by step ==="
              
              # Step 1: Prepare
              make O=out ARCH=arm64 prepare 2>&1 | tee prepare.log || {
                echo "âŒ Prepare step failed"
                exit 1
              }
              
              # Step 2: Build scripts
              make O=out ARCH=arm64 scripts 2>&1 | tee scripts.log || {
                echo "âŒ Scripts step failed"
                exit 1
              }
              
              # Step 3: Try to build modules first
              make O=out ARCH=arm64 modules 2>&1 | tee modules.log || {
                echo "âŒ Modules build failed"
                exit 1
              }
              
              # Step 4: Build the kernel
              make O=out ARCH=arm64 2>&1 | tee final_build.log || {
                echo "âŒ Final build failed"
                tail -50 final_build.log
                exit 1
              }
            }
          fi
          
          # Check if kernel was built
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ KERNEL BUILT SUCCESSFULLY! ðŸŽ‰ðŸŽ‰ðŸŽ‰"
            ls -lh out/arch/arm64/boot/Image
          else
            echo "âŒ Kernel Image not found!"
            exit 1
          fi

      # STEP 8: Create flashable package
      - name: Create Flashable Package
        if: success()
        run: |
          cd kernel
          
          mkdir -p anykernel
          cp out/arch/arm64/boot/Image anykernel/
          
          cat > anykernel/anykernel.sh << 'EOF'
          #!/system/bin/sh
          
          ui_print " "
          ui_print "*******************************"
          ui_print "* GKI Kernel for Samsung A135F"
          ui_print "* With KernelSU Support"
          ui_print "* Build Date: $(date +%Y-%m-%d)"
          ui_print "*******************************"
          ui_print " "
          
          device=$(getprop ro.product.device)
          model=$(getprop ro.product.model)
          ui_print "- Device: $device"
          ui_print "- Model: $model"
          
          ui_print "- Backing up current kernel..."
          dd if=/dev/block/by-name/boot of=/sdcard/boot_backup.img 2>/dev/null || true
          
          ui_print "- Flashing new kernel..."
          dd if=/tmp/anykernel/Image of=/dev/block/by-name/boot 2>/dev/null || true
          
          ui_print "- Done!"
          ui_print " "
          EOF
          
          chmod +x anykernel/anykernel.sh
          
          cd anykernel
          zip -r9 ../A135F-GKI-Kernel.zip *
          
          echo "âœ… Package created"

      # STEP 9: Upload artifacts
      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: A135F-Kernel
          path: |
            kernel/out/arch/arm64/boot/Image
            kernel/A135F-GKI-Kernel.zip
          retention-days: 7

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Logs
          path: |
            kernel/build*.log
            kernel/config*.log
            kernel/*.log
          retention-days: 3
