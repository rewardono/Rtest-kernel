name: Build GKI-like Kernel for A135F
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Setup Environment
      run: |
        sudo apt update
        sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev git wget \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu python3 ccache

    - name: Get Kernel Source
      run: |
        git clone https://github.com/samsungexynos850/atlas kernel --depth=1

    - name: Apply Critical Fixes
      run: |
        cd kernel

        # === Fix watchdog.c: remove entire Samsung softlockup block ===
        if [ -f "kernel/watchdog.c" ]; then
          echo "Fixing watchdog.c: removing Samsung softlockup code..."
          sed -i '/^#ifdef CONFIG_SOFTLOCKUP_DETECTOR$/,/^#endif$/d' kernel/watchdog.c
          sed -i '/percpu_sl_info\|sl_to_name\|check_softlockup_type/d' kernel/watchdog.c
        fi

        # === Fix need_memory_boosting ===
        echo '#ifndef need_memory_boosting
static inline bool need_memory_boosting(void) { return false; }
#endif' >> include/linux/mm.h

        # === Remove problematic Samsung subsystems entirely ===
        rm -rf \
          kernel/sched/ems/ \
          drivers/soc/samsung/bts/ \
          drivers/staging/sec_debug/ \
          kernel/trace/sec/

        # === Stub any lingering includes ===
        find . -type f \( -name "*.c" -o -name "*.h" \) -exec sed -i \
          -e 's|#include ".*ems/.*"|// REMOVED EMS|g' \
          -e 's|#include <linux/ems.h>|// REMOVED EMS|g' \
          -e 's|#include ".*bts.*"|// REMOVED BTS|g' \
          {} \;

        # === Fix systrace_mark.h ===
        sed -i 's|systrace_mark_end()\s*__systrace_mark(SYSTRACE_MARK_TYPE_END, "")|systrace_mark_end() __systrace_mark(SYSTRACE_MARK_TYPE_END, "end")|' include/trace/systrace_mark.h 2>/dev/null || true

        # === Fix process.c unused variable ===
        sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused *sys_state[SYSTEM_END] = {/' kernel/power/process.c 2>/dev/null || true

        # === Fix bpf_trace.c inline issue ===
        sed -i 's/static inline __printf(1, 0)/static __noinline __printf(1, 0)/' kernel/trace/bpf_trace.c 2>/dev/null || true

    - name: Add KernelSU
      run: |
        cd kernel
        git clone https://github.com/tiann/KernelSU ksu_tmp --depth=1
        mv ksu_tmp/kernel drivers/kernelsu
        echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
        echo 'obj-y += kernelsu/' >> drivers/Makefile
        rm -rf ksu_tmp

    - name: Configure Kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        mkdir -p out

        # Use defconfig since gki_defconfig DOES NOT EXIST in this tree
        make O=out ARCH=arm64 defconfig

        chmod +x scripts/config

        # Enable KernelSU
        ./scripts/config --file out/.config --enable KSU
        ./scripts/config --file out/.config --set-str KSU_GIT_VERSION "gh-action"

        # Disable module signing
        ./scripts/config --file out/.config --disable MODULE_SIG
        ./scripts/config --file out/.config --disable MODULE_SIG_ALL
        ./scripts/config --file out/.config --disable MODULE_SIG_FORCE

        # Aggressively disable Samsung debug & scheduler features
        ./scripts/config --file out/.config --disable SEC_DEBUG
        ./scripts/config --file out/.config --disable SEC_DEBUG_EXTRA_INFO
        ./scripts/config --file out/.config --disable EXYNOS_BTS
        ./scripts/config --file out/.config --disable SCHED_EMS
        ./scripts/config --file out/.config --disable SOFTLOCKUP_DETECTOR_EXTENSION
        ./scripts/config --file out/.config --disable SEC_DEBUG_HARDLOCKUP_DETECTOR
        ./scripts/config --file out/.config --disable SEC_DEBUG_SOFTLOCKUP_DETECTOR
        ./scripts/config --file out/.config --disable SEC_DEBUG_WATCHDOG

        # Fix devfreq error: disable broken governor
        ./scripts/config --file out/.config --disable DEVFREQ_GOV_SIMPLE_ONDEMAND

        # Enforce GKI-like setting (optional but recommended)
        echo "CONFIG_GKI_KERNEL=y" >> out/.config

        make O=out ARCH=arm64 olddefconfig

    - name: Build Kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export KCFLAGS="-w -Wno-error -Wno-error=implicit-function-declaration -Wno-error=incompatible-pointer-types"

        echo "ðŸš€ Starting kernel build..."

        if make O=out ARCH=arm64 -j$(nproc) 2>&1 | tee build.log; then
          echo "âœ… Build succeeded!"
        else
          echo "âŒ Build failed"
          grep -A10 -B5 -i "error:" build.log || tail -50 build.log
          exit 1
        fi

        if [ ! -f "out/arch/arm64/boot/Image" ]; then
          echo "âŒ Kernel Image not found!"
          find out -name "Image*" | head -10
          exit 1
        fi

        echo "ðŸŽ‰ KERNEL BUILT SUCCESSFULLY"
        ls -lh out/arch/arm64/boot/Image

    - name: Create AnyKernel3 Package
      if: success()
      run: |
        cd kernel
        wget -q https://github.com/osm0sis/AnyKernel3/archive/master.zip -O ak3.zip
        unzip -q ak3.zip
        mv AnyKernel3-master anykernel
        rm -rf ak3.zip

        cp out/arch/arm64/boot/Image anykernel/

        cat > anykernel/anykernel.sh << 'EOF'
#!/system/bin/sh
# AnyKernel3 Ramdisk Mod Script
properties() {
kernel.string=Atlas-GKI-Kernel
do.devicecheck=1
do.modules=0
do.systemless=1
do.cleanup=1
device.name1=a13
device.name2=a135f
device.name3=SM-A135F
}
block=/dev/block/by-name/boot;
is_slot_device=0;
ramdisk_compression=auto;
. tools/ak3-core.sh;
dump_boot;
write_boot;
EOF

        chmod +x anykernel/anykernel.sh
        cd anykernel
        zip -r9 ../Atlas-GKI-Kernel-$(date +%Y%m%d).zip .

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-artifacts
        path: |
          kernel/out/arch/arm64/boot/Image
          kernel/Atlas-GKI-Kernel-*.zip

    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          kernel/build.log
          kernel/out/.config
