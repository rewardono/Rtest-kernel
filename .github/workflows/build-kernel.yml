name: Build GKI Kernel for A135F - ULTIMATE SOLUTION
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - name: Install Dependencies (WITHOUT ccache)
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu
          # DO NOT install ccache at all
      
      - name: Create Fake ccache Command
        run: |
          # Create a fake ccache command that does nothing
          echo '#!/bin/bash' | sudo tee /usr/local/bin/ccache
          echo '#!/bin/bash' | sudo tee /usr/local/bin/cache
          
          # For ccache: just pass through to gcc
          echo 'shift  # Remove ccache from arguments' | sudo tee -a /usr/local/bin/ccache
          echo 'exec gcc "$@"' | sudo tee -a /usr/local/bin/ccache
          
          # For cache: also pass through to gcc
          echo 'shift  # Remove cache from arguments' | sudo tee -a /usr/local/bin/cache
          echo 'exec gcc "$@"' | sudo tee -a /usr/local/bin/cache
          
          sudo chmod +x /usr/local/bin/ccache
          sudo chmod +x /usr/local/bin/cache
          
          # Verify they exist
          which ccache
          which cache
          ccache --version 2>&1 || echo "Fake ccache created"
      
      - name: Get FRESH Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
      
      - name: Apply COMPLETE Patching
        run: |
          cd kernel
          
          echo "Applying COMPLETE patches to kernel source..."
          
          # 1. Fix the unused variable
          sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c
          
          # 2. COMPLETELY disable ccache in EVERY Makefile
          echo "Removing ALL ccache references..."
          
          # Main Makefile - COMPLETE removal
          sed -i 's/^[[:space:]]*ccache[[:space:]]*//g' Makefile
          sed -i 's/[[:space:]]ccache[[:space:]]/ /g' Makefile
          sed -i 's/^[[:space:]]*cache[[:space:]]*//g' Makefile
          sed -i 's/[[:space:]]cache[[:space:]]/ /g' Makefile
          sed -i 's/$(ccache)//g' Makefile
          sed -i 's/$(cache)//g' Makefile
          
          # Remove any CCACHE variables
          sed -i '/^CCACHE/d' Makefile
          sed -i '/^export.*CCACHE/d' Makefile
          sed -i '/^unexport.*CCACHE/d' Makefile
          
          # Patch scripts/Makefile.host - where the error occurs
          if [ -f "scripts/Makefile.host" ]; then
            echo "Patching scripts/Makefile.host..."
            sed -i 's/ccache //g' scripts/Makefile.host
            sed -i 's/cache //g' scripts/Makefile.host
            sed -i 's/$(ccache)//g' scripts/Makefile.host
            sed -i 's/$(cache)//g' scripts/Makefile.host
          fi
          
          # Patch ALL Makefiles recursively
          find . -type f -name "Makefile*" -exec sed -i 's/ccache //g' {} \; 2>/dev/null || true
          find . -type f -name "Makefile*" -exec sed -i 's/cache //g' {} \; 2>/dev/null || true
          find . -type f -name "Kbuild*" -exec sed -i 's/ccache //g' {} \; 2>/dev/null || true
          find . -type f -name "Kbuild*" -exec sed -i 's/cache //g' {} \; 2>/dev/null || true
          
          # Also patch any shell scripts that might call ccache
          find . -type f -name "*.sh" -exec sed -i 's/ccache //g' {} \; 2>/dev/null || true
          
          # 3. Fix malformed compiler flags
          echo "Fixing malformed compiler flags..."
          sed -i 's/=return-type/-Wreturn-type/g' Makefile 2>/dev/null || true
          sed -i 's/=-Wreturn-type/-Wreturn-type/g' Makefile 2>/dev/null || true
          
          # Find and fix all malformed flags
          for flag in return-type missing-prototypes unused-but-set-variable; do
            find . -type f \( -name "Makefile*" -o -name "Kbuild*" \) \
              -exec sed -i "s/=$flag/-W$flag/g" {} \; 2>/dev/null || true
            find . -type f \( -name "Makefile*" -o -name "Kbuild*" \) \
              -exec sed -i "s/=-W$flag/-W$flag/g" {} \; 2>/dev/null || true
          done
          
          # 4. Disable Werror completely
          sed -i 's/-Werror//g' Makefile
          sed -i 's/WERROR.*=.*1/WERROR = 0/g' Makefile
          
          echo "All patches applied!"
      
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          git clone https://github.com/tiann/KernelSU --depth=1 ksu_tmp
          mv ksu_tmp/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          rm -rf ksu_tmp
      
      - name: Build with EXPLICIT Compiler Settings
        run: |
          cd kernel
          
          # Clean everything
          make distclean 2>/dev/null || true
          rm -f .config
          
          # Set environment - EXPLICITLY set compilers
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Set HOST compiler explicitly (this is critical!)
          export HOSTCC=gcc
          export HOSTCXX=g++
          
          # Set target compiler explicitly
          export CC=aarch64-linux-gnu-gcc
          export CXX=aarch64-linux-gnu-g++
          
          # Make sure our fake ccache is in PATH
          export PATH="/usr/local/bin:$PATH"
          
          echo "Configuring kernel..."
          
          # Configure with our explicit settings
          make gki_defconfig
          
          # Enable KSU and modules
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
          
          # Save config
          cp .config .config.before_build
          
          echo "Starting build..."
          echo "This will take 15-20 minutes..."
          
          # Build with verbose output
          make V=1 -j$(nproc) 2>&1 | tee build.log
          
          # Check if successful
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "✅ KERNEL BUILD SUCCESSFUL!"
            echo "File: arch/arm64/boot/Image"
            echo "Size: $(du -h arch/arm64/boot/Image | cut -f1)"
            file arch/arm64/boot/Image
          else
            echo "❌ Build failed"
            echo "=== Checking for specific errors ==="
            
            # Look for the actual error
            grep -i "error\|fail" build.log | tail -20 || true
            
            # Try to build with single core for debugging
            echo "=== Trying single-core build for debugging ==="
            make clean
            make V=1 -j1 2>&1 | tail -100
            
            exit 1
          fi
      
      - name: Create Flashable Package
        run: |
          cd kernel
          
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "Creating flashable package..."
            
            # Create anykernel3 directory structure
            mkdir -p anykernel/META-INF/com/google/android
            mkdir -p anykernel/kernelsu
            
            # Copy kernel
            cp arch/arm64/boot/Image anykernel/
            
            # Create updater-script
            cat > anykernel/META-INF/com/google/android/updater-script << 'EOF'
            ui_print("Flashing GKI Kernel for A135F");
            ui_print("With KernelSU Support");
            ui_print("Device: Samsung Galaxy A135F");
            ui_print("Build date: $(date)");
            mount("ext4", "EMMC", "/dev/block/platform/13540000.dwmmc0/by-name/SYSTEM", "/system");
            package_extract_dir("kernelsu", "/data/adb/kernelsu");
            set_perm_recursive(0, 0, 0755, 0755, "/data/adb/kernelsu");
            unmount("/system");
            EOF
            
            # Create anykernel script
            cat > anykernel/anykernel.sh << 'EOF'
            #!/system/bin/sh
            # AnyKernel3 Ramdisk Mod Script
            
            ## AnyKernel setup
            properties() {
              kernel.string=GKI Kernel for A135F
              do.devicecheck=1
              do.modules=0
              do.systemless=1
              do.cleanup=1
              device.name1=a13
              device.name2=a135f
              device.name3=a13x
            }
            
            ## AnyKernel install
            dump_boot;
            write_boot;
            EOF
            
            chmod +x anykernel/anykernel.sh
            
            # Create flashable zip
            cd anykernel
            zip -r9 ../A135F-GKI-Kernel.zip *
            
            echo "Flashable zip created!"
            ls -lh ../A135F-GKI-Kernel.zip
          else
            echo "No kernel Image found, skipping package creation"
          fi
      
      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-Image
          path: |
            kernel/arch/arm64/boot/Image
            kernel/.config.before_build
          retention-days: 7
      
      - name: Upload Flashable Zip
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Flashable-Zip
          path: kernel/A135F-GKI-Kernel.zip
          retention-days: 7
      
      - name: Upload Build Log
        uses: actions/upload-artifact@v4
        with:
          name: Build-Log
          path: kernel/build.log
          retention-days: 3
