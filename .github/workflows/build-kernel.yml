name: Build GKI Kernel for Samsung A135F
on:
  workflow_dispatch:  # Allows manual triggering

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      # Step 1: Install all dependencies
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            ccache \
            wget \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu
          
          # Fix the cache typo in the kernel source
          sudo ln -sf /usr/bin/ccache /usr/local/bin/cache
          echo "âœ… Dependencies installed"
      
      # Step 2: Get the kernel source
      - name: Get Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
          echo "âœ… Kernel source downloaded"
      
      # Step 3: Fix all compilation issues
      - name: Fix Compilation Issues
        run: |
          cd kernel
          
          # Fix 1: Unused variable warning
          sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c
          
          # Fix 2: Malformed compiler flags
          echo "Fixing malformed compiler flags..."
          find . -type f \( -name "Makefile*" -o -name "Kbuild*" \) -exec sed -i 's/-implicit-function-declaration/-Wimplicit-function-declaration/g' {} \; 2>/dev/null || true
          find . -type f \( -name "Makefile*" -o -name "Kbuild*" \) -exec sed -i 's/=return-type/-Wreturn-type/g' {} \; 2>/dev/null || true
          
          # Fix 3: Remove problematic Werror flags
          sed -i 's/-Werror-implicit-function-declaration//g' Makefile
          sed -i 's/WERROR.*=.*1/WERROR = 0/g' Makefile
          
          echo "âœ… All fixes applied"
      
      # Step 4: Add KernelSU
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          wget -q https://github.com/tiann/KernelSU/archive/main.tar.gz -O ksu.tar.gz
          tar -xzf ksu.tar.gz
          mv KernelSU-main/kernel drivers/kernelsu
          
          # Add KernelSU to build system
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          
          rm -rf KernelSU-main ksu.tar.gz
          echo "âœ… KernelSU added"
      
      # Step 5: Configure the kernel
      - name: Configure Kernel
        run: |
          cd kernel
          
          # Clean any previous builds
          make distclean 2>/dev/null || true
          rm -f .config
          
          # Set environment
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Configure for GKI
          make gki_defconfig
          
          # Enable KernelSU
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
          
          # Disable module signing to prevent bootloops
          echo "# CONFIG_MODULE_SIG is not set" >> .config
          echo "# CONFIG_MODULE_SIG_FORCE is not set" >> .config
          
          echo "âœ… Kernel configured"
          cp .config .config.before_build
      
      # Step 6: Build the kernel
      - name: Build Kernel
        run: |
          cd kernel
          
          echo "ğŸš€ Building kernel... This will take 10-20 minutes"
          
          # Build with all available cores
          make -j$(nproc) 2>&1 | tee build.log
          
          # Check if build was successful
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "ğŸ‰ SUCCESS! Kernel built successfully!"
            echo "Kernel size: $(du -h arch/arm64/boot/Image | cut -f1)"
          else
            echo "âŒ Build failed"
            echo "=== Last 50 lines of build log ==="
            tail -50 build.log
            exit 1
          fi
      
      # Step 7: Create flashable package
      - name: Create Flashable Package
        run: |
          cd kernel
          
          echo "ğŸ“¦ Creating flashable package..."
          
          # Create AnyKernel3 structure
          mkdir -p anykernel
          cp arch/arm64/boot/Image anykernel/
          
          # Create anykernel.sh script
          cat > anykernel/anykernel.sh << 'EOF'
          #!/system/bin/sh
          # AnyKernel3 Ramdisk Mod Script
          
          ## AnyKernel setup
          properties() {
            kernel.string=GKI Kernel for A135F
            do.devicecheck=1
            do.modules=0
            do.systemless=1
            do.cleanup=1
            device.name1=a13
            device.name2=a135f
            device.name3=a13x
          }
          
          ## AnyKernel install
          dump_boot;
          write_boot;
          ## end install
          EOF
          
          chmod +x anykernel/anykernel.sh
          
          # Create zip
          cd anykernel
          zip -r9 ../A135F-GKI-Kernel.zip *
          
          echo "âœ… Flashable zip created: A135F-GKI-Kernel.zip"
          ls -lh ../A135F-GKI-Kernel.zip
      
      # Step 8: Upload artifacts
      - name: Upload Kernel Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: A135F-Kernel-Files
          path: |
            kernel/arch/arm64/boot/Image
            kernel/A135F-GKI-Kernel.zip
            kernel/.config.before_build
          retention-days: 7
      
      - name: Upload Build Log
        uses: actions/upload-artifact@v4
        with:
          name: Build-Logs
          path: kernel/build.log
          retention-days: 3
