name: Build GKI Kernel for A135F
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            gcc-aarch64-linux-gnu \
            ccache
          
          # Create a symlink for 'cache' -> 'ccache' to fix the typo
          sudo ln -sf /usr/bin/ccache /usr/bin/cache
          
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
      
      - name: Clone Kernel Source
        run: |
          # Remove existing kernel directory first
          rm -rf kernel
          git clone --depth=1 --single-branch \
            https://github.com/samsungexynos850/atlas kernel
      
      - name: Quick Fix for ccache typo
        run: |
          cd kernel
          # First, check if Makefile has the 'cache' typo
          echo "=== Checking for 'cache' typo in Makefile ==="
          grep -n "cache" Makefile || echo "No 'cache' found in Makefile"
          
          # Create a wrapper script for 'cache' in local directory
          cat > cache-wrapper.sh << 'EOF'
          #!/bin/bash
          # Wrapper to fix 'cache' -> 'ccache' typo
          exec /usr/bin/ccache "$@"
          EOF
          chmod +x cache-wrapper.sh
      
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          git clone --depth=1 https://github.com/tiann/KernelSU ksu_tmp
          mv ksu_tmp/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          rm -rf ksu_tmp
      
      - name: Build Kernel
        run: |
          cd kernel
          
          # Set environment variables
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Try different approaches to fix the ccache issue
          export USE_CCACHE=1
          export CCACHE_DIR=/tmp/ccache
          mkdir -p $CCACHE_DIR
          
          # Add current directory to PATH for our wrapper
          export PATH="$PWD:$PATH"
          
          mkdir -p out
          
          echo "Configuring kernel..."
          if [ ! -f "arch/arm64/configs/gki_defconfig" ]; then
            echo "ERROR: gki_defconfig not found!"
            ls arch/arm64/configs/
            exit 1
          fi
          
          # Try building without ccache first
          echo "Attempting to build without ccache..."
          make O=out ARCH=arm64 gki_defconfig CC="gcc" HOSTCC="gcc"
          
          # Enable KernelSU and modules
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' out/.config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' out/.config
          
          # Try building with explicit CC settings
          echo "Starting build..."
          make O=out ARCH=arm64 CC="gcc" HOSTCC="gcc" -j2 2>&1 | tee build.log
      
      - name: Check Build
        run: |
          cd kernel
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "✓ Build successful!"
            ls -lh out/arch/arm64/boot/Image
            echo "Size: $(du -h out/arch/arm64/boot/Image | cut -f1)"
          else
            echo "✗ Build failed"
            echo "=== Build log summary ==="
            tail -100 build.log
            echo "=== Looking for specific errors ==="
            grep -i "error\|fail" build.log | head -20
          fi
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build
          path: |
            kernel/out/arch/arm64/boot/
            kernel/build.log
          retention-days: 1
