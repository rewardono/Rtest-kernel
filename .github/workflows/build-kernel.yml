name: Build GKI Kernel for A135F - PROPER FIX
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - name: Install Dependencies (No ccache)
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu
          # DO NOT install ccache
      
      - name: Create Fake Cache Wrapper
        run: |
          # Create a wrapper script that intercepts "cache" calls
          # and passes them directly to the compiler
          cat > /tmp/cache-wrapper.sh << 'EOF'
          #!/bin/bash
          # This wrapper intercepts calls to "cache" and passes them to the real compiler
          
          # Remove the first argument if it's "cache"
          if [ "$1" = "cache" ]; then
              shift
          fi
          
          # Check if we're being called as a compiler wrapper
          # If so, run the real compiler instead
          if [ "$1" = "gcc" ] || [ "$1" = "g++" ] || [ "$1" = "aarch64-linux-gnu-gcc" ]; then
              shift
          fi
          
          # Call the real compiler
          exec aarch64-linux-gnu-gcc "$@"
          EOF
          
          chmod +x /tmp/cache-wrapper.sh
          
          # Also create a simple "cache" command that just runs gcc
          echo '#!/bin/bash' | sudo tee /usr/local/bin/cache
          echo 'exec aarch64-linux-gnu-gcc "$@"' | sudo tee -a /usr/local/bin/cache
          sudo chmod +x /usr/local/bin/cache
          
          # Create gcc wrapper for host compiler
          echo '#!/bin/bash' | sudo tee /usr/local/bin/cache-gcc
          echo 'exec gcc "$@"' | sudo tee -a /usr/local/bin/cache-gcc
          sudo chmod +x /usr/local/bin/cache-gcc
      
      - name: Get Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
      
      - name: Patch Kernel Source Completely
        run: |
          cd kernel
          
          # 1. Fix the unused variable
          sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c
          
          # 2. COMPLETELY remove ccache/cache references from ALL Makefiles
          echo "Removing all ccache/cache references..."
          
          # Main Makefile - replace cache with empty string
          sed -i 's/^[[:space:]]*cache[[:space:]]*//g' Makefile
          sed -i 's/[[:space:]]cache[[:space:]]/ /g' Makefile
          sed -i 's/"cache"//g' Makefile
          sed -i 's/$(cache)//g' Makefile
          
          # Remove CCACHE definition
          sed -i '/^CCACHE/d' Makefile
          sed -i '/^export CCACHE/d' Makefile
          
          # Patch scripts/Makefile.host
          if [ -f "scripts/Makefile.host" ]; then
            sed -i 's/^[[:space:]]*cache[[:space:]]*//g' scripts/Makefile.host
            sed -i 's/[[:space:]]cache[[:space:]]/ /g' scripts/Makefile.host
            sed -i 's/"cache"//g' scripts/Makefile.host
          fi
          
          # Patch all other Makefiles
          find . -name "Makefile*" -type f -exec sed -i 's/ cache / /g' {} \; 2>/dev/null || true
          find . -name "Makefile*" -type f -exec sed -i 's/"cache"//g' {} \; 2>/dev/null || true
          
          # Remove problematic compiler flags
          sed -i 's/-Wno-error-implicit-function-declaration//g' Makefile
          sed -i 's/-Werror-implicit-function-declaration//g' Makefile
          
          # Disable Werror completely
          sed -i 's/-Werror//g' Makefile
          sed -i 's/WERROR.*=.*1/WERROR = 0/g' Makefile
          
          echo "Patching complete!"
      
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          git clone https://github.com/tiann/KernelSU --depth=1 ksu_tmp
          mv ksu_tmp/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          rm -rf ksu_tmp
      
      - name: Build Kernel - NO CCACHE AT ALL
        run: |
          cd kernel
          
          # Clean everything
          make distclean 2>/dev/null || true
          rm -f .config
          
          # Set environment - EXPLICITLY disable ccache
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Force disable ccache
          unset CCACHE_DISABLE
          unset USE_CCACHE
          export CCACHE_DISABLE=1
          export USE_CCACHE=0
          
          # Add our wrapper to PATH temporarily
          export PATH="/usr/local/bin:$PATH"
          
          echo "Configuring kernel..."
          make gki_defconfig
          
          # Enable KSU and modules
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
          
          # Save config
          cp .config .config.patched
          
          echo "Starting build (this will take 15-20 minutes)..."
          
          # Build with single core first to see errors clearly
          make -j1 2>&1 | tee build_single.log
          
          # Check if successful
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "âœ… Build successful with single core!"
            # Now try with more cores
            echo "Building with all cores..."
            make -j$(nproc) 2>&1 | tee build_full.log
          else
            echo "âš ï¸ Single core build failed, checking errors..."
            tail -100 build_single.log
            echo "Trying alternative approach..."
            
            # Try building without our PATH modification
            export PATH=$(echo "$PATH" | sed 's|/usr/local/bin:||')
            make clean
            make gki_defconfig
            sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
            sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
            
            # Build directly with explicit compiler
            make CC="aarch64-linux-gnu-gcc" HOSTCC="gcc" -j1 2>&1 | tee build_direct.log
            
            if [ -f "arch/arm64/boot/Image" ]; then
              echo "âœ… Build successful with direct compiler!"
            else
              echo "âŒ All build attempts failed"
              echo "=== Last errors from direct build ==="
              tail -50 build_direct.log
              exit 1
            fi
          fi
          
          # Final verification
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "ðŸŽ‰ KERNEL SUCCESSFULLY BUILT!"
            echo "File: arch/arm64/boot/Image"
            echo "Size: $(du -h arch/arm64/boot/Image | cut -f1)"
            file arch/arm64/boot/Image
          else
            echo "âŒ No kernel Image found"
            exit 1
          fi
      
      - name: Create Simple Package
        run: |
          cd kernel
          
          echo "Creating artifacts..."
          mkdir -p artifacts
          cp arch/arm64/boot/Image artifacts/
          
          # Create info file
          cat > artifacts/README.md << 'EOF'
          # GKI Kernel for Samsung A135F
          
          ## File: Image
          - This is the raw kernel binary
          - Built for Exynos 850 (Samsung A135F)
          - GKI (Generic Kernel Image) version
          - KernelSU enabled
          
          ## How to flash:
          
          1. **Extract boot.img** from your device's stock firmware
          2. **Use Android Image Kitchen** (AIK) to unpack boot.img
          3. **Replace** the kernel file with this Image
          4. **Repack** boot.img
          5. **Flash** with Odin (AP slot)
          
          OR
          
          1. Use **AnyKernel3** template
          2. Replace Image in the zip
          3. Flash via custom recovery (if available)
          
          ## Backup your current kernel first!
          EOF
          
          echo "Artifacts ready:"
          ls -lh artifacts/
      
      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: A135F-GKI-KERNEL
          path: kernel/artifacts/
          retention-days: 7
