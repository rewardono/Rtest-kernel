name: ğŸš€ GKI Kernel Builder - ULTIMATE
on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Clean build'
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
      # PHASE 1: SETUP - NO FAILURE POSSIBLE
      - name: ğŸ”§ Setup Environment
        run: |
          # Update and install WITHOUT any interruptions
          sudo apt update && sudo apt upgrade -y
          DEBIAN_FRONTEND=noninteractive sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            wget \
            curl \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            python3 \
            make \
            rsync
            
          # Remove ALL cache-related packages
          sudo apt remove --purge -y ccache 2>/dev/null || true
          
          # Create multiple fallback ccache commands
          echo '#!/bin/bash' | sudo tee /usr/bin/ccache
          echo '#!/bin/bash' | sudo tee /usr/local/bin/ccache
          echo '#!/bin/bash' | sudo tee /bin/ccache
          echo 'shift; exec "$@"' | sudo tee -a /usr/bin/ccache /usr/local/bin/ccache /bin/ccache
          sudo chmod +x /usr/bin/ccache /usr/local/bin/ccache /bin/ccache
          
          # Verify installation
          which gcc && which aarch64-linux-gnu-gcc && which make

      # PHASE 2: SOURCE - FRESH EVERY TIME
      - name: ğŸ“¥ Get Kernel Source
        run: |
          rm -rf kernel
          git clone --depth=1 --branch=main https://github.com/samsungexynos850/atlas kernel
          echo "Source size: $(du -sh kernel)"

      # PHASE 3: FIXES - APPLY ALL KNOWN FIXES
      - name: ğŸ”¨ Apply All Known Fixes
        run: |
          cd kernel
          
          # 1. SEC_DEBUG.H FIX - The panic() macro issue
          echo "Fixing sec_debug.h..."
          if grep -q "secdbg_exin_get_unfz" include/linux/sec_debug.h 2>/dev/null; then
            sed -i 's/#define secdbg_exin_get_unfz(a).*/#define secdbg_exin_get_unfz(a) (char\*)""/' include/linux/sec_debug.h
            echo "Fixed sec_debug.h"
          fi
          
          # 2. PROCESS.C FIX - Unused variable
          echo "Fixing process.c..."
          sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c 2>/dev/null || true
          
          # 3. CCACHE REMOVAL - Nuclear option
          echo "Removing ALL ccache references..."
          find . -type f \( -name "Makefile*" -o -name "Kbuild*" -o -name "*.mk" \) ! -path "./.git/*" -exec sed -i 's/\bccache\b//g' {} \;
          
          # 4. COMPILER FLAGS FIX - All patterns we've seen
          echo "Fixing compiler flags..."
          find . -type f \( -name "Makefile*" -o -name "Kbuild*" \) -exec sed -i \
            -e 's/-Werror-Wreturn-type/-Werror -Wreturn-type/g' \
            -e 's/-Werror-Wimplicit-function-declaration/-Werror -Wimplicit-function-declaration/g' \
            -e 's/-Werror-implicit-function-declaration/-Werror -Wimplicit-function-declaration/g' \
            -e 's/-implicit-function-declaration/-Wimplicit-function-declaration/g' \
            -e 's/=return-type/-Wreturn-type/g' \
            {} \;
          
          # 5. HOSTCC FORCE - Set to gcc explicitly
          echo "Setting HOSTCC/HOSTCXX..."
          sed -i 's/^HOSTCC\s*:=.*/HOSTCC := gcc/' Makefile 2>/dev/null || true
          sed -i 's/^HOSTCXX\s*:=.*/HOSTCXX := g++/' Makefile 2>/dev/null || true
          
          if [ -f "scripts/Makefile.host" ]; then
            sed -i 's/^HOSTCC\s*:=.*/HOSTCC := gcc/' scripts/Makefile.host
            sed -i 's/^HOSTCXX\s*:=.*/HOSTCXX := g++/' scripts/Makefile.host
          fi
          
          echo "âœ… All fixes applied"

      # PHASE 4: KERNELSU - SIMPLE INTEGRATION
      - name: âš¡ Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          
          # Download KernelSU directly
          curl -L https://github.com/tiann/KernelSU/archive/refs/heads/main.tar.gz | tar -xz
          mv KernelSU-main/kernel drivers/kernelsu
          
          # Add to build system
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          
          rm -rf KernelSU-main

      # PHASE 5: CONFIGURATION - MULTI-STEP
      - name: âš™ï¸ Configure Kernel
        run: |
          cd kernel
          
          # Clean everything
          rm -rf out .config .config.old
          
          # Set environment explicitly
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export HOSTCC=gcc
          export HOSTCXX=g++
          export CCACHE_DISABLE=1
          
          # Create output directory
          mkdir -p out
          
          # Step 1: Base config
          make O=out ARCH=arm64 gki_defconfig 2>&1 | tee config_step1.log || true
          
          # Step 2: Enable KernelSU
          echo "CONFIG_KSU=y" >> out/.config
          echo "CONFIG_MODULES=y" >> out/.config
          echo "# CONFIG_MODULE_SIG is not set" >> out/.config
          echo "# CONFIG_MODULE_SIG_FORCE is not set" >> out/.config
          
          # Step 3: Update config
          make O=out ARCH=arm64 olddefconfig 2>&1 | tee config_step2.log || true
          
          echo "Configuration complete"

      # PHASE 6: PRE-BUILD FIXES - FIX GENERATED FILES
      - name: ğŸ”§ Fix Generated Build Files
        run: |
          cd kernel
          
          echo "Fixing generated Makefiles..."
          
          # Fix any generated Makefiles
          find out -type f -name "Makefile*" -exec sed -i \
            -e 's/-Werror-Wreturn-type/-Wreturn-type/g' \
            -e 's/-Werror-Wimplicit-function-declaration/-Wimplicit-function-declaration/g' \
            -e 's/\bccache\b//g' \
            {} \; 2>/dev/null || true
          
          # Ensure HOSTCC is correct in generated files
          if [ -f "out/scripts/Makefile.host" ]; then
            sed -i 's/^HOSTCC\s*:=.*/HOSTCC := gcc/' out/scripts/Makefile.host
          fi

      # PHASE 7: BUILD - WITH MULTIPLE FALLBACKS
      - name: ğŸ—ï¸ Build Kernel
        run: |
          cd kernel
          
          # Export build environment
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export HOSTCC=gcc
          export HOSTCXX=g++
          export KCFLAGS="-Wno-error -Wno-return-type -Wno-implicit-function-declaration"
          
          echo "Starting build process..."
          
          # Attempt 1: Normal parallel build
          echo "=== Attempt 1: Parallel Build ==="
          if make O=out ARCH=arm64 -j$(nproc) 2>&1 | tee build_attempt1.log; then
            echo "âœ… Build succeeded on first attempt!"
          else
            echo "âš ï¸ Attempt 1 failed, trying Attempt 2..."
            
            # Attempt 2: Single core build
            echo "=== Attempt 2: Single Core Build ==="
            make O=out ARCH=arm64 clean 2>/dev/null || true
            
            if make O=out ARCH=arm64 -j1 2>&1 | tee build_attempt2.log; then
              echo "âœ… Build succeeded on second attempt!"
            else
              echo "âš ï¸ Attempt 2 failed, trying Attempt 3..."
              
              # Attempt 3: Build with explicit overrides
              echo "=== Attempt 3: Explicit Override Build ==="
              make O=out ARCH=arm64 clean 2>/dev/null || true
              
              # Build with maximum tolerance for errors
              if make O=out ARCH=arm64 CFLAGS_KERNEL="-w" HOSTCFLAGS="-w" -j1 2>&1 | tee build_attempt3.log; then
                echo "âœ… Build succeeded on third attempt!"
              else
                echo "âŒ All build attempts failed"
                
                # Show what went wrong
                echo "=== ERROR ANALYSIS ==="
                tail -200 build_attempt3.log | grep -A10 -B10 "error:" || tail -200 build_attempt3.log
                
                # Check for specific known errors
                if grep -q "secdbg_exin_get_unfz" build_attempt3.log; then
                  echo "ERROR: sec_debug.h issue still present"
                fi
                if grep -q "ccache" build_attempt3.log; then
                  echo "ERROR: ccache issue still present"
                fi
                if grep -q "Werror-W" build_attempt3.log; then
                  echo "ERROR: Compiler flag issue still present"
                fi
                
                exit 1
              fi
            fi
          fi
          
          # Verify the kernel was built
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "ğŸ‰ğŸ‰ğŸ‰ KERNEL BUILD SUCCESSFUL! ğŸ‰ğŸ‰ğŸ‰"
            echo "File: out/arch/arm64/boot/Image"
            echo "Size: $(du -h out/arch/arm64/boot/Image | cut -f1)"
            file out/arch/arm64/boot/Image
          else
            echo "âŒ Kernel image not found!"
            find out -name "Image" -o -name "Image.gz" -o -name "*.img" 2>/dev/null
            exit 1
          fi

      # PHASE 8: PACKAGE - SIMPLE FLASHABLE ZIP
      - name: ğŸ“¦ Create Flashable Package
        if: success()
        run: |
          cd kernel
          
          echo "Creating flashable package..."
          
          # Create anykernel structure
          mkdir -p anykernel
          cp out/arch/arm64/boot/Image anykernel/
          
          # Minimal anykernel script
          cat > anykernel/anykernel.sh << 'EOF'
#!/system/bin/sh
echo " "
echo "GKI Kernel for Samsung A135F"
echo "With KernelSU Support"
echo " "
dd if=/tmp/anykernel/Image of=/dev/block/by-name/boot
echo "Done!"
EOF
          
          chmod +x anykernel/anykernel.sh
          
          # Create zip
          cd anykernel
          zip -r9 ../kernel.zip .
          
          echo "Package created: kernel.zip"
          ls -lh ../kernel.zip

      # PHASE 9: ARTIFACTS - UPLOAD EVERYTHING
      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build-$(date +%s)
          path: |
            kernel/out/arch/arm64/boot/Image
            kernel/kernel.zip
            kernel/out/.config
          retention-days: 7

      - name: ğŸ“‹ Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-$(date +%s)
          path: |
            kernel/build_attempt*.log
            kernel/config_step*.log
          retention-days: 3
