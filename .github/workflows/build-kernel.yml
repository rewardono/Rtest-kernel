name: Build Exynos850 GKI-Compatible Kernel v17

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Setup Environment
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          python3 ccache

    - name: Clone Kernel Source
      run: |
        git clone https://github.com/samsungexynos850/atlas kernel
        cd kernel
        git submodule update --init --recursive

    - name: Apply Minimal Required Patches
      run: |
        cd kernel

        # bpf_trace fix (known GCC issue)
        sed -i 's/static inline __printf/static __printf/' \
          kernel/trace/bpf_trace.c || true

        # sec_debug stub
        sed -i 's/^#define secdbg_exin_get_unfz.*/#define secdbg_exin_get_unfz(a) ("")/' \
          include/linux/sec_debug.h || true

    - name: Add KernelSU
      run: |
        cd kernel
        git clone https://github.com/tiann/KernelSU drivers/kernelsu
        echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
        echo 'obj-y += kernelsu/' >> drivers/Makefile

    - name: Configure Kernel (Vendor Base)
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        mkdir -p out
        make O=out exynos850-atlas_defconfig

        chmod +x scripts/config

        # KernelSU
        scripts/config --file out/.config --enable KSU
        scripts/config --file out/.config \
          --set-str KSU_GIT_VERSION "github-actions"

        # GKI compatibility essentials
        scripts/config --file out/.config --enable BPF
        scripts/config --file out/.config --enable BPF_SYSCALL
        scripts/config --file out/.config --enable IKHEADERS
        scripts/config --file out/.config --enable MODULES

        # Disable known vendor-problematic features
        scripts/config --file out/.config --disable SENSORHUB
        scripts/config --file out/.config --disable INPUT_BOOSTER
        scripts/config --file out/.config --disable EMS
        scripts/config --file out/.config --disable EXYNOS_BTS
        scripts/config --file out/.config --disable SEC_DEBUG

        make O=out olddefconfig

    - name: Build Kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        make O=out -j$(nproc)

        test -f out/arch/arm64/boot/Image

    - name: Upload Kernel Image
      uses: actions/upload-artifact@v4
      with:
        name: Image
        path: kernel/out/arch/arm64/boot/Image
