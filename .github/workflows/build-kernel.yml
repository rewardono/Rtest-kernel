name: Build Kernel for A135F

on:workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
      - name: Setup
        run: |
          sudo apt update
          sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev git wget \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu python3

      - name: Clone Kernel
        run: |
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1

      - name: Remove Samsung Subsystems
        run: |
          cd kernel

          # Remove entire problematic directories
          rm -rf \
            kernel/sched/ems/ \
            drivers/soc/samsung/bts/ \
            drivers/staging/sec_debug/ \
            kernel/trace/sec/ \
            drivers/sensorhub/ \
            drivers/input/input_booster.c \
            include/linux/input/input_booster.h

          # Remove references in Kconfig/Makefile
          sed -i '/ems\|bts\|sec_debug\|sensorhub\|input_booster/d' \
            drivers/Kconfig drivers/Makefile kernel/Makefile

          # Fix watchdog.c: remove Samsung softlockup block completely
          if [ -f kernel/watchdog.c ]; then
            sed -i '/#ifdef CONFIG_SOFTLOCKUP_DETECTOR/,/#endif/d' kernel/watchdog.c
            sed -i '/check_softlockup_type\|percpu_sl_info\|sl_to_name/d' kernel/watchdog.c
          fi

          # Fix need_memory_boosting
          echo '#ifndef need_memory_boosting
static inline bool need_memory_boosting(void) { return false; }
#endif' >> include/linux/mm.h

          # Fix bpf_trace.c
          sed -i 's/static inline __printf(1, 0)/static __noinline __printf(1, 0)/' \
            kernel/trace/bpf_trace.c 2>/dev/null || true

      - name: Add KernelSU
        run: |
          cd kernel
          git clone https://github.com/tiann/KernelSU ksu --depth=1
          mv ksu/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile

      - name: Configure Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          mkdir -p out

          # Use defconfig (gki_defconfig DOES NOT EXIST)
          make O=out ARCH=arm64 defconfig

          chmod +x scripts/config

          # Enable KernelSU
          ./scripts/config --file out/.config --enable KSU
          ./scripts/config --file out/.config --set-str KSU_GIT_VERSION "gh-action"

          # Disable signing
          ./scripts/config --file out/.config --disable MODULE_SIG MODULE_SIG_ALL MODULE_SIG_FORCE

          # Aggressively disable Samsung features
          ./scripts/config --file out/.config --disable \
            SEC_DEBUG EXYNOS_BTS SCHED_EMS EMS EMSTUNE \
            SENSORHUB SSP_SENSOR INPUT_BOOSTER SEC_INPUT_BOOSTER \
            SOFTLOCKUP_DETECTOR_EXTENSION SEC_DEBUG_HARDLOCKUP_DETECTOR \
            SEC_DEBUG_SOFTLOCKUP_DETECTOR SEC_DEBUG_WATCHDOG \
            DEVFREQ_GOV_SIMPLE_ONDEMAND SCSI_UFSHCD XDP_SOCKETS \
            CPU_THERMAL EXYNOS_THERMAL BLUETOOTH BT

          # Enforce GKI-like setting
          echo "CONFIG_GKI_KERNEL=y" >> out/.config

          make O=out ARCH=arm64 olddefconfig

      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export KCFLAGS="-w -Wno-error"

          make O=out ARCH=arm64 -j$(nproc) 2>&1 | tee build.log

          if [ ! -f out/arch/arm64/boot/Image ]; then
            echo "âŒ Build failed or Image missing"
            grep -A5 -B5 -i "error:" build.log || tail -20 build.log
            exit 1
          fi
          echo "âœ… Kernel built successfully!"

      - name: Package with AnyKernel3
        if: success()
        run: |
          cd kernel
          wget -q https://github.com/osm0sis/AnyKernel3/archive/master.zip -O ak3.zip
          unzip -q ak3.zip
          mv AnyKernel3-master anykernel
          cp out/arch/arm64/boot/Image anykernel/

          cat > anykernel/anykernel.sh << 'EOF'
#!/system/bin/sh
properties() {
kernel.string=A135F-GKI-Kernel
do.devicecheck=1
do.modules=0
do.systemless=1
device.name1=a13
device.name2=a135f
}
block=/dev/block/by-name/boot;
is_slot_device=0;
ramdisk_compression=auto;
. tools/ak3-core.sh;
dump_boot;
write_boot;
EOF

          chmod +x anykernel/anykernel.sh
          cd anykernel
          zip -r9 ../A135F-Kernel-$(date +%Y%m%d).zip .

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel
          path: |
            kernel/out/arch/arm64/boot/Image
            kernel/A135F-Kernel-*.zip
