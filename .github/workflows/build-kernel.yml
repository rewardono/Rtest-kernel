name: Build GKI Kernel for Samsung A135F - COMPILER FLAG FIX
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      # STEP 1: Clean install
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            wget \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu

      # STEP 2: Fresh kernel
      - name: Get Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1

      # STEP 3: TARGETED FIX for the exact error
      - name: Fix Compiler Flags (Targeted)
        run: |
          cd kernel
          
          echo "=== FIXING COMPILER FLAGS ==="
          
          # Create a script to find and fix ALL occurrences of the bad flag
          cat > fix_flags.sh << 'EOF'
          #!/bin/bash
          
          # Search for the exact problematic pattern
          echo "Searching for -Werror-Wreturn-type..."
          grep -r "-Werror-Wreturn-type" . --include="*.mk" --include="Makefile*" --include="Kbuild*" 2>/dev/null | while read match; do
            file=$(echo "$match" | cut -d: -f1)
            echo "Fixing: $file"
            # Replace -Werror-Wreturn-type with -Werror -Wreturn-type
            sed -i 's/-Werror-Wreturn-type/-Werror -Wreturn-type/g' "$file"
          done
          
          echo "Searching for -Werror-Wimplicit-function-declaration..."
          grep -r "-Werror-Wimplicit-function-declaration" . --include="*.mk" --include="Makefile*" --include="Kbuild*" 2>/dev/null | while read match; do
            file=$(echo "$match" | cut -d: -f1)
            echo "Fixing: $file"
            sed -i 's/-Werror-Wimplicit-function-declaration/-Werror -Wimplicit-function-declaration/g' "$file"
          done
          
          # Also fix -Werror-implicit-function-declaration (missing dash)
          echo "Searching for -Werror-implicit-function-declaration..."
          grep -r "-Werror-implicit-function-declaration" . --include="*.mk" --include="Makefile*" --include="Kbuild*" 2>/dev/null | while read match; do
            file=$(echo "$match" | cut -d: -f1)
            echo "Fixing: $file"
            sed -i 's/-Werror-implicit-function-declaration/-Werror -Wimplicit-function-declaration/g' "$file"
          done
          
          # Fix in the root Makefile specifically
          if [ -f "Makefile" ]; then
            echo "Fixing root Makefile..."
            # Check what KBUILD_CFLAGS contains
            grep -n "KBUILD_CFLAGS" Makefile | head -5
            
            # Fix any malformed flags
            sed -i 's/-Werror-Wreturn-type/-Werror -Wreturn-type/g' Makefile
            sed -i 's/-Werror-Wimplicit-function-declaration/-Werror -Wimplicit-function-declaration/g' Makefile
            sed -i 's/-Werror-implicit-function-declaration/-Werror -Wimplicit-function-declaration/g' Makefile
          fi
          
          # Also check scripts/Makefile.build (where the error occurred)
          if [ -f "scripts/Makefile.build" ]; then
            echo "Fixing scripts/Makefile.build..."
            sed -i 's/-Werror-Wreturn-type/-Werror -Wreturn-type/g' scripts/Makefile.build
          fi
          
          echo "âœ… Flag fixing complete"
          EOF
          
          chmod +x fix_flags.sh
          ./fix_flags.sh
          
          # Original unused variable fix
          sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c 2>/dev/null || true
          
          echo "=== VERIFICATION ==="
          echo "Checking if bad flags still exist..."
          grep -r "-Werror-Wreturn-type\|-Werror-Wimplicit-function-declaration\|-Werror-implicit-function-declaration" . --include="*.mk" --include="Makefile*" --include="Kbuild*" 2>/dev/null && echo "âŒ Bad flags found!" || echo "âœ… No bad flags found"

      # STEP 4: Add KernelSU
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          
          wget -q https://github.com/tiann/KernelSU/archive/main.tar.gz -O ksu.tar.gz
          tar -xzf ksu.tar.gz
          mv KernelSU-main/kernel drivers/kernelsu
          
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          
          rm -rf KernelSU-main ksu.tar.gz

      # STEP 5: Configure with DISABLED WERROR
      - name: Configure Kernel (No Werror)
        run: |
          cd kernel
          
          # Clean
          rm -rf out 2>/dev/null || true
          
          # Export with NO WERROR
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export HOSTCC=gcc
          export HOSTCXX=g++
          export KCFLAGS="-Wno-error"
          
          mkdir -p out
          
          # Configure
          make O=out ARCH=arm64 gki_defconfig 2>&1 | tee config1.log
          
          # Enable KernelSU
          echo "CONFIG_KSU=y" >> out/.config
          echo "CONFIG_MODULES=y" >> out/.config
          
          # Update config
          make O=out ARCH=arm64 olddefconfig 2>&1 | tee config2.log

      # STEP 6: PRE-BUILD FIX: Patch the generated Makefile
      - name: Fix Generated Makefile
        run: |
          cd kernel
          
          echo "=== Fixing generated Makefile in out/ ==="
          
          if [ -f "out/Makefile" ]; then
            echo "Patching out/Makefile..."
            # Fix compiler flags in the generated Makefile
            sed -i 's/-Werror-Wreturn-type/-Werror -Wreturn-type/g' out/Makefile
            sed -i 's/-Werror-Wimplicit-function-declaration/-Werror -Wimplicit-function-declaration/g' out/Makefile
            sed -i 's/-Werror-implicit-function-declaration/-Werror -Wimplicit-function-declaration/g' out/Makefile
            
            # Also check KBUILD_CFLAGS
            echo "Current KBUILD_CFLAGS:"
            grep "KBUILD_CFLAGS" out/Makefile | head -3
          fi
          
          # Also fix scripts/Makefile.build in out directory
          if [ -f "out/scripts/Makefile.build" ]; then
            echo "Patching out/scripts/Makefile.build..."
            sed -i 's/-Werror-Wreturn-type/-Werror -Wreturn-type/g' out/scripts/Makefile.build
          fi

      # STEP 7: Build with EXPLICIT flag override
      - name: Build Kernel (With Flag Override)
        run: |
          cd kernel
          
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export HOSTCC=gcc
          export HOSTCXX=g++
          
          echo "ðŸš€ Starting build with KCFLAGS override..."
          
          # Build with KCFLAGS that DISABLES the problematic warnings
          make O=out ARCH=arm64 KCFLAGS="-Wno-error=return-type -Wno-error=implicit-function-declaration" -j$(nproc) 2>&1 | tee build.log || {
            echo "âŒ Build failed with KCFLAGS, trying different approach..."
            
            # Alternative: Build with CFLAGS_MODULE
            make O=out ARCH=arm64 clean 2>/dev/null || true
            
            echo "Trying with CFLAGS_MODULE override..."
            make O=out ARCH=arm64 CFLAGS_MODULE="-Wno-error=return-type -Wno-error=implicit-function-declaration" -j$(nproc) 2>&1 | tee build2.log || {
              echo "âŒ Second attempt failed, trying single core..."
              
              # Last resort: Single core with verbose output
              make O=out ARCH=arm64 clean 2>/dev/null || true
              make O=out ARCH=arm64 -j1 V=1 2>&1 | tee build3.log || {
                echo "âŒ Final attempt failed"
                echo "=== SHOWING ERROR ==="
                grep -A5 -B5 "unrecognized command-line option" build3.log
                exit 1
              }
            }
          }
          
          # Check for kernel
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ SUCCESS! Kernel built! ðŸŽ‰ðŸŽ‰ðŸŽ‰"
            ls -lh out/arch/arm64/boot/Image
          else
            echo "âŒ Kernel Image not found"
            exit 1
          fi

      # STEP 8: Create flashable package
      - name: Create Flashable Package
        if: success()
        run: |
          cd kernel
          
          mkdir -p anykernel
          cp out/arch/arm64/boot/Image anykernel/
          
          cat > anykernel/anykernel.sh << 'EOF'
          #!/system/bin/sh
          
          ui_print " "
          ui_print "*******************************"
          ui_print "* GKI Kernel for Samsung A135F"
          ui_print "* With KernelSU Support"
          ui_print "* Build Date: $(date +%Y-%m-%d)"
          ui_print "*******************************"
          ui_print " "
          
          device=$(getprop ro.product.device)
          model=$(getprop ro.product.model)
          ui_print "- Device: $device"
          ui_print "- Model: $model"
          
          ui_print "- Backing up current kernel..."
          dd if=/dev/block/by-name/boot of=/sdcard/boot_backup.img 2>/dev/null || true
          
          ui_print "- Flashing new kernel..."
          dd if=/tmp/anykernel/Image of=/dev/block/by-name/boot 2>/dev/null || true
          
          ui_print "- Done!"
          ui_print " "
          EOF
          
          chmod +x anykernel/anykernel.sh
          
          cd anykernel
          zip -r9 ../A135F-GKI-Kernel.zip *

      # STEP 9: Upload artifacts
      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: A135F-Kernel-Build
          path: |
            kernel/out/arch/arm64/boot/Image
            kernel/A135F-GKI-Kernel.zip
          retention-days: 7

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Logs
          path: |
            kernel/build.log
            kernel/build2.log
            kernel/build3.log
            kernel/config1.log
            kernel/config2.log
          retention-days: 3
