name: Build GKI Kernel for A135F - FINAL FIX
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            python3
      
      - name: Get Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
      
      - name: Fix All Compilation Issues
        run: |
          cd kernel
          
          # 1. Fix the unused variable
          sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c
          
          # 2. Fix the malformed =return-type flag
          # Search for the pattern "=return-type" and fix it
          echo "Searching for malformed compiler flags..."
          grep -r "=return-type" . 2>/dev/null || echo "No =return-type found in grep"
          
          # Look in Makefiles for suspicious patterns
          find . -name "Makefile*" -type f -exec grep -l "return-type" {} \; 2>/dev/null || true
          
          # Common fix: replace =return-type with -Wreturn-type
          find . -type f -name "Makefile*" -exec sed -i 's/=return-type/-Wreturn-type/g' {} \; 2>/dev/null || true
          find . -type f -name "Kbuild*" -exec sed -i 's/=return-type/-Wreturn-type/g' {} \; 2>/dev/null || true
          find . -type f -name "*.mk" -exec sed -i 's/=return-type/-Wreturn-type/g' {} \; 2>/dev/null || true
          
          # 3. Also fix other potential malformed flags
          # The pattern =something suggests missing -W or -f
          echo "Checking for other malformed flags..."
          for flag in return-type missing-prototypes unused-but-set-variable; do
            find . -type f \( -name "Makefile*" -o -name "Kbuild*" -o -name "*.mk" \) \
              -exec sed -i "s/=$flag/-W$flag/g" {} \; 2>/dev/null || true
          done
          
          # 4. Check the main Makefile for compiler flag definitions
          echo "Checking Makefile for KBUILD_CFLAGS..."
          grep -n "KBUILD_CFLAGS\|KBUILD_CFLAGS_KERNEL" Makefile | head -20
          
          # 5. Remove any problematic ccache/cache references
          sed -i 's/ccache //g' Makefile 2>/dev/null || true
          sed -i 's/cache //g' Makefile 2>/dev/null || true
      
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          git clone https://github.com/tiann/KernelSU --depth=1 ksu_tmp
          mv ksu_tmp/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          rm -rf ksu_tmp
      
      - name: Build Kernel with Debug Info
        run: |
          cd kernel
          
          # Clean everything
          make distclean 2>/dev/null || true
          rm -f .config
          
          # Set environment
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Disable ccache completely
          unset CCACHE_DISABLE
          unset USE_CCACHE
          export CCACHE_DISABLE=1
          
          echo "Configuring kernel..."
          make gki_defconfig
          
          # Enable KSU and modules
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
          
          # Save config
          cp .config .config.patched
          
          echo "Building kernel with debug output..."
          
          # Build with verbose output to see exact compiler commands
          # First, build only the problematic target to see the exact command
          echo "=== Testing kernel/bounds.s compilation ==="
          make V=1 kernel/bounds.s 2>&1 | tee bounds_build.log
          
          if [ -f "kernel/bounds.s" ]; then
            echo "âœ… kernel/bounds.s built successfully!"
            echo "Now building full kernel..."
            
            # Build the full kernel
            make -j$(nproc) 2>&1 | tee full_build.log
            
            if [ -f "arch/arm64/boot/Image" ]; then
              echo "ðŸŽ‰ Kernel build successful!"
            else
              echo "âŒ Full build failed after bounds.s succeeded"
              tail -100 full_build.log
              exit 1
            fi
          else
            echo "âŒ Failed to build kernel/bounds.s"
            echo "=== Looking for exact compiler command ==="
            grep "aarch64-linux-gnu-gcc" bounds_build.log | head -5
            
            # Try to manually see what flags are being passed
            echo "=== Checking compiler flags in Kbuild ==="
            if [ -f "kernel/Kbuild" ]; then
              grep -n "cflags" kernel/Kbuild || true
            fi
            
            # Try alternative: build with minimal flags
            echo "=== Trying with minimal CFLAGS ==="
            make clean
            
            # Export minimal CFLAGS
            export KCFLAGS="-Wall -Werror"
            
            make gki_defconfig
            sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
            sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
            
            # Try building bounds.s with explicit command
            echo "Building bounds.s with explicit command..."
            cd kernel
            aarch64-linux-gnu-gcc -Wall -Werror -S -o bounds.s bounds.c 2>&1 || echo "Manual build failed"
            cd ..
            
            # One more attempt: check the exact command from make
            echo "=== Running make with extreme verbosity ==="
            make V=2 kernel/bounds.s 2>&1 | grep -A2 -B2 "gcc" | head -20
            
            exit 1
          fi
      
      - name: Try Alternative Build Method
        if: failure()
        run: |
          cd kernel
          
          echo "Trying alternative build method..."
          
          # Clean
          make distclean 2>/dev/null || true
          
          # Create a minimal .config manually
          echo "Creating minimal .config..."
          cat > .config << 'EOF'
          # CONFIG_KSU is not set
          CONFIG_MODULES=y
          CONFIG_MODULE_UNLOAD=y
          # CONFIG_MODULE_FORCE_UNLOAD is not set
          CONFIG_MODVERSIONS=y
          CONFIG_MODULE_SRCVERSION_ALL=y
          # CONFIG_MODULE_SIG is not set
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_EMBEDDED=y
          CONFIG_SLOB=y
          EOF
          
          # Set architecture
          export ARCH=arm64
          
          # Run olddefconfig to set defaults
          make olddefconfig
          
          # Now enable KSU
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          
          # Try building with different approach
          echo "Building with alternative method..."
          make -j1 2>&1 | tee alt_build.log
          
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "âœ… Alternative build successful!"
          else
            echo "âŒ Alternative build failed"
            tail -100 alt_build.log
            exit 1
          fi
      
      - name: Prepare Artifacts
        if: success()
        run: |
          cd kernel
          
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "ðŸŽ‰ SUCCESS! Kernel built!"
            echo "File: arch/arm64/boot/Image"
            echo "Size: $(du -h arch/arm64/boot/Image | cut -f1)"
            
            mkdir -p artifacts
            cp arch/arm64/boot/Image artifacts/
            
            # Create a simple anykernel script
            cat > artifacts/flash.sh << 'EOF'
            #!/system/bin/sh
            # Simple flash script
            
            echo "Flashing GKI kernel for A135F..."
            echo "Make sure you have backup!"
            
            # Mount boot if needed
            mount -o rw,remount / || true
            
            # Backup original kernel
            if [ -f "/dev/block/platform/.../by-name/boot" ]; then
              dd if=/dev/block/platform/.../by-name/boot of=/sdcard/boot_backup.img
            fi
            
            echo "Replace this script with proper flashing logic"
            echo "For now, manually flash using:"
            echo "1. Android Image Kitchen to unpack boot.img"
            echo "2. Replace kernel with this Image file"
            echo "3. Repack and flash with Odin"
            EOF
            
            chmod +x artifacts/flash.sh
            
            echo "Artifacts ready:"
            ls -lh artifacts/
          else
            echo "âŒ No kernel Image found"
            exit 1
          fi
      
      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: A135F-GKI-KERNEL
          path: kernel/artifacts/
          retention-days: 7
