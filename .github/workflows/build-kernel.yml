name: Build GKI Kernel for A135F - FINAL
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            wget \
            unzip \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu
      
      - name: Fix ccache typo PERMANENTLY
        run: |
          # Create a bash script that redirects 'cache' to 'ccache'
          echo '#!/bin/bash' | sudo tee /usr/local/bin/cache
          echo 'exec /usr/bin/ccache "$@"' | sudo tee -a /usr/local/bin/cache
          sudo chmod +x /usr/local/bin/cache
          
          # Verify it works
          which cache
          cache --version
      
      - name: Get Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
      
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          wget -q https://github.com/tiann/KernelSU/archive/refs/heads/main.zip -O ksu.zip
          unzip -q ksu.zip
          mv KernelSU-main/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          rm -rf KernelSU-main ksu.zip
      
      - name: Apply ALL Critical Fixes
        run: |
          cd kernel
          
          # 1. Fix the unused variable warning in process.c
          sed -i '49s/const char \*sys_state\[SYSTEM_END\]/const char __maybe_unused \*sys_state\[SYSTEM_END\]/' kernel/power/process.c
          
          # 2. Directly patch the Makefile to fix the cache typo
          sed -i 's/ cache / ccache /g' Makefile
          sed -i 's/"cache"/"ccache"/g' Makefile
          sed -i 's/$(cache)/$(ccache)/g' Makefile
          
          # 3. Also check scripts/Makefile.host
          if [ -f "scripts/Makefile.host" ]; then
            sed -i 's/ cache / ccache /g' scripts/Makefile.host
            sed -i 's/"cache"/"ccache"/g' scripts/Makefile.host
          fi
          
          # 4. Disable Werror completely
          find . -name "Makefile*" -type f -exec sed -i 's/-Werror//g' {} \; 2>/dev/null || true
          find . -name "Kbuild*" -type f -exec sed -i 's/-Werror//g' {} \; 2>/dev/null || true
          
          echo "All fixes applied!"
      
      - name: Build Kernel - SIMPLE APPROACH
        run: |
          cd kernel
          
          # Clean everything
          make distclean 2>/dev/null || true
          rm -f .config
          
          # SIMPLE environment - no ccache, no complex flags
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # DISABLE ccache completely
          unset CCACHE
          unset USE_CCACHE
          
          # Configure
          echo "Configuring kernel..."
          make gki_defconfig
          
          # Enable KSU
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
          
          # Save config
          cp .config config_final
          
          # Build with verbose output
          echo "Building kernel... (this will take 5-10 minutes)"
          time make -j$(nproc) 2>&1 | tee build.log
          
          # Check result
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "âœ“ BUILD SUCCESSFUL!"
            echo "Kernel size: $(du -h arch/arm64/boot/Image | cut -f1)"
          else
            echo "âœ— Build failed"
            echo "=== Last 100 lines of build log ==="
            tail -100 build.log
            echo "=== Looking for specific error ==="
            grep -i "error\|fail" build.log | tail -20
            exit 1
          fi
      
      - name: Create Flashable Package
        run: |
          cd kernel
          
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "Creating flashable package..."
            
            # Create AnyKernel3 structure
            mkdir -p anykernel
            cp arch/arm64/boot/Image anykernel/
            
            # Create anykernel script
            cat > anykernel/anykernel.sh << 'EOF'
            #!/system/bin/sh
            # AnyKernel3 Ramdisk Mod Script
            # osm0sis @ xda-developers
            
            ## AnyKernel setup
            # begin properties
            properties() {
              kernel.string=GKI Kernel for A135F
              do.devicecheck=1
              do.modules=0
              do.systemless=1
              do.cleanup=1
              do.cleanuponabort=0
              device.name1=a13
              device.name2=a135f
              device.name3=a13x
            }
            
            ## AnyKernel file attributes
            # set permissions/ownership for included ramdisk files
            # set_perm_recursive 0 0 0755 0644;
            # set_perm_recursive 0 0 0755 0755;
            
            ## AnyKernel install
            dump_boot;
            
            # begin ramdisk changes
            
            # end ramdisk changes
            
            write_boot;
            ## end install
            EOF
            
            chmod +x anykernel/anykernel.sh
            
            # Create flashable zip
            cd anykernel
            zip -r9 ../A135F-GKI-Kernel.zip *
            
            echo "Flashable zip created!"
            ls -lh ../A135F-GKI-Kernel.zip
          fi
      
      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-Image
          path: |
            kernel/arch/arm64/boot/Image
            kernel/config_final
          retention-days: 7
      
      - name: Upload Flashable Zip
        uses: actions/upload-artifact@v4
        with:
          name: Flashable-Zip
          path: kernel/A135F-GKI-Kernel.zip
          retention-days: 7
      
      - name: Upload Build Log
        uses: actions/upload-artifact@v4
        with:
          name: Build-Log
          path: kernel/build.log
          retention-days: 3
