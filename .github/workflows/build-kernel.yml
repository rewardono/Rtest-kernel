name: Build Kernel - FINAL
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Setup
      run: |
        sudo apt update
        sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev git wget curl gcc-aarch64-linux-gnu g++-aarch64-linux-gnu python3
        
        # Create simple ccache
        echo '#!/bin/bash' > /tmp/ccache
        echo 'exec "$@"' >> /tmp/ccache
        chmod +x /tmp/ccache
        sudo mv /tmp/ccache /usr/bin/
    
    - name: Get Source
      run: |
        rm -rf kernel
        git clone https://github.com/samsungexynos850/atlas kernel --depth=1
    
    - name: Apply Fixes
      run: |
        cd kernel
        
        # 1. Fix sec_debug.h
        sed -i 's|#define secdbg_exin_get_unfz(a).*|#define secdbg_exin_get_unfz(a) ("")|' include/linux/sec_debug.h 2>/dev/null || true
        
        # 2. Fix process.c
        sed -i '49s|const char \*sys_state\[SYSTEM_END\] = {|const char __maybe_unused \*sys_state\[SYSTEM_END\] = {|' kernel/power/process.c 2>/dev/null || true
        
        # 3. Fix compiler flags in all Makefiles
        find . -type f -name "Makefile*" -exec sed -i \
          -e 's|-Werror-Wreturn-type|-Wreturn-type|g' \
          -e 's|-Werror-Wimplicit-function-declaration|-Wimplicit-function-declaration|g' \
          {} \; 2>/dev/null || true
        
        # 4. Remove ccache from build system
        sed -i 's|ccache||g' Makefile 2>/dev/null || true
        sed -i 's|^HOSTCC.*|HOSTCC = gcc|' Makefile 2>/dev/null || true
        
        # 5. Fix systrace_mark.h
        sed -i 's|systrace_mark_end()\s*__systrace_mark(SYSTRACE_MARK_TYPE_END, "")|systrace_mark_end()    __systrace_mark(SYSTRACE_MARK_TYPE_END, "end")|' include/trace/systrace_mark.h 2>/dev/null || true
        
        # 6. Fix ems.h - add __maybe_unused
        if [ -f "include/linux/ems.h" ]; then
          sed -i 's|static void emstune_|static __maybe_unused void emstune_|g' include/linux/ems.h 2>/dev/null || true
          sed -i 's|static int emstune_|static __maybe_unused int emstune_|g' include/linux/ems.h 2>/dev/null || true
          sed -i '/static inline void frt_limit_fast_cpu/d' include/linux/ems.h 2>/dev/null || true
        fi
        
        # 7. Fix missing functions
        echo 'static inline bool need_memory_boosting(void) { return false; }' >> include/linux/mm.h 2>/dev/null || true
        
        # 8. Fix format specifier
        sed -i 's|%u|%llu|g' mm/page_alloc.c 2>/dev/null || true
    
    - name: Add KernelSU
      run: |
        cd kernel
        rm -rf drivers/kernelsu
        wget -q https://github.com/tiann/KernelSU/archive/main.tar.gz -O ksu.tar.gz
        tar -xzf ksu.tar.gz
        mv KernelSU-main/kernel drivers/kernelsu
        echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
        echo 'obj-y += kernelsu/' >> drivers/Makefile
        rm -rf KernelSU-main ksu.tar.gz
    
    - name: Configure
      run: |
        cd kernel
        rm -rf out
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export HOSTCC=gcc
        mkdir -p out
        make O=out gki_defconfig
        echo "CONFIG_KSU=y" >> out/.config
        echo "CONFIG_MODULES=y" >> out/.config
        make O=out olddefconfig
    
    - name: Build
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export HOSTCC=gcc
        
        # Build with NO warnings as errors
        if make O=out -j$(nproc) KCFLAGS="-w" 2>&1 | tee build.log; then
          echo "Build successful!"
        else
          echo "Build failed, trying single core..."
          make O=out clean 2>/dev/null || true
          make O=out -j1 KCFLAGS="-w" 2>&1 | tee build_single.log
        fi
        
        if [ -f "out/arch/arm64/boot/Image" ]; then
          echo "SUCCESS: Kernel built!"
          ls -lh out/arch/arm64/boot/Image
        else
          echo "ERROR: Kernel not found"
          exit 1
        fi
    
    - name: Package
      if: success()
      run: |
        cd kernel
        mkdir -p anykernel
        cp out/arch/arm64/boot/Image anykernel/
        echo 'dd if=/tmp/anykernel/Image of=/dev/block/by-name/boot' > anykernel/anykernel.sh
        chmod +x anykernel/anykernel.sh
        cd anykernel
        zip -r9 ../kernel.zip .
    
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: kernel
        path: kernel/out/arch/arm64/boot/Image
