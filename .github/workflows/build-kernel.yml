name: Build Kernel - Clean GKI-style v1
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Setup environment
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 ccache \
          clang-17 lld-17 llvm-17 \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          libncurses-dev
        sudo ln -sf /usr/bin/ccache /usr/local/bin/ccache || true

    - name: Get kernel source
      run: |
        rm -rf kernel
        git clone https://github.com/samsungexynos850/atlas kernel --depth=1

    - name: Add minimal patches
      run: |
        cd kernel

        # bpf_trace.c: varargs function must not be inline
        if [ -f "kernel/trace/bpf_trace.c" ]; then
          sed -i 's/static inline __printf(1, 0) int bpf_do_trace_printk/static __noinline __printf(1, 0) int bpf_do_trace_printk/' kernel/trace/bpf_trace.c || true
        fi

        # sec_debug.h: macro signature mismatch -> safe stub
        if [ -f "include/linux/sec_debug.h" ]; then
          perl -0777 -pe 's/#define\s+secdbg_exin_get_unfz\([^\)]*\).*/#define secdbg_exin_get_unfz(a) ""/s' -i include/linux/sec_debug.h || true
        fi

        # BTS driver include fix
        if [ -f "drivers/soc/samsung/cal-if/pwrcal-env.h" ]; then
          sed -i 's|#include "types.h"|#include <linux/types.h>|' drivers/soc/samsung/cal-if/pwrcal-env.h || true
        fi

        # Avoid source deletions; rely on Kconfig disables below

    - name: Prepare GKI fragment config
      run: |
        cd kernel
        cat > gki_fragment.config << 'EOF'
        # Disable Samsung vendor subsystems that break GKI-style builds
        # Debug/watchdog/vendor
        CONFIG_SEC_DEBUG=n
        CONFIG_SEC_DEBUG_EXTRA_INFO=n
        CONFIG_SOFTLOCKUP_DETECTOR_EXTENSION=n
        CONFIG_SEC_DEBUG_HARDLOCKUP_DETECTOR=n
        CONFIG_SEC_DEBUG_SOFTLOCKUP_DETECTOR=n
        CONFIG_SEC_DEBUG_WATCHDOG=n
        CONFIG_SOFTLOCKUP_DETECTOR=n

        # Scheduler/EMS
        CONFIG_SCHED_EMS=n
        CONFIG_SCHED_EMSTUNE=n
        CONFIG_EMS=n
        CONFIG_EMSTUNE=n
        CONFIG_EMS_TUNE=n

        # Input booster
        CONFIG_INPUT_BOOSTER=n
        CONFIG_SEC_INPUT_BOOSTER=n

        # Sensorhub
        CONFIG_SENSORHUB=n
        CONFIG_SSP_SENSOR=n

        # BTS
        CONFIG_EXYNOS_BTS=n

        # UFS (vendor tree conflicts)
        CONFIG_SCSI_UFSHCD=n

        # XDP sockets (struct mismatches)
        CONFIG_XDP_SOCKETS=n

        # Thermal (vendor redefs)
        CONFIG_CPU_THERMAL=n
        CONFIG_EXYNOS_THERMAL=n

        # Bluetooth (hci_sock vendor diffs)
        CONFIG_BT=n
        CONFIG_BLUETOOTH=n

        # Devfreq governor simple_ondemand is fine; avoid Samsung extensions
        CONFIG_DEVFREQ_GOV_SIMPLE_ONDEMAND=y
        # If present:
        # CONFIG_SAMSUNG_DEVFREQ_EXTENSION=n

        # KernelSU
        CONFIG_KSU=y
        EOF

    - name: Add KernelSU
      run: |
        cd kernel
        rm -rf drivers/kernelsu
        git clone https://github.com/tiann/KernelSU ksu_tmp --depth=1
        mv ksu_tmp/kernel drivers/kernelsu
        echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
        echo 'obj-y += kernelsu/' >> drivers/Makefile
        rm -rf ksu_tmp

    - name: Configure kernel (Clang + merged config)
      run: |
        cd kernel
        rm -rf out
        mkdir -p out

        export ARCH=arm64
        export LLVM=1
        export CC=clang
        export LD=ld.lld
        export CROSS_COMPILE=aarch64-linux-gnu-
        export KBUILD_BUILD_USER="github"
        export KBUILD_BUILD_HOST="actions"

        # Base defconfig; vendor tree may not have gki_defconfig‚Äîfallback to defconfig if needed
        if grep -q '^config GKI' Kconfig 2>/dev/null; then
          make O=out ARCH=arm64 gki_defconfig
        else
          make O=out ARCH=arm64 defconfig
        fi

        # Merge fragment
        chmod +x scripts/kconfig/merge_config.sh || true
        scripts/kconfig/merge_config.sh -m -O out out/.config gki_fragment.config

        # Set KernelSU version and disable module signing
        ./scripts/config --file out/.config --set-str KSU_GIT_VERSION "github-action-build"
        ./scripts/config --file out/.config --disable MODULE_SIG
        ./scripts/config --file out/.config --disable MODULE_SIG_ALL
        ./scripts/config --file out/.config --disable MODULE_SIG_FORCE

        make O=out ARCH=arm64 olddefconfig

    - name: Build kernel (Clang/LLD)
      run: |
        cd kernel
        export ARCH=arm64
        export LLVM=1
        export CC=clang
        export LD=ld.lld
        export CROSS_COMPILE=aarch64-linux-gnu-
        export KCFLAGS="-Wno-error -Wno-attribute-alias -Wno-implicit-function-declaration -Wno-incompatible-pointer-types"

        echo "üöÄ Starting kernel build..."
        if make O=out ARCH=arm64 -j$(nproc) 2>&1 | tee build.log; then
          echo "‚úÖ Parallel build successful!"
        else
          echo "‚ö†Ô∏è Parallel build failed; trying single-core..."
          make O=out ARCH=arm64 clean || true
          if make O=out ARCH=arm64 -j1 2>&1 | tee build_single.log; then
            echo "‚úÖ Single-core build successful!"
          else
            echo "‚ùå Build failed with single core"
            echo "=== LAST 100 LINES ==="
            tail -100 build_single.log || true
            exit 1
          fi
        fi

        if [ -f "out/arch/arm64/boot/Image" ]; then
          ls -lh out/arch/arm64/boot/Image
          echo "Size: $(wc -c < out/arch/arm64/boot/Image) bytes"
        else
          echo "‚ùå Kernel Image not found!"
          find out -name "Image" -o -name "Image.gz" | head -10
          exit 1
        fi

    - name: Create AnyKernel3 package
      if: success()
      run: |
        cd kernel
        wget -q https://github.com/osm0sis/AnyKernel3/archive/master.zip -O anykernel.zip
        unzip -q anykernel.zip -d anykernel_temp
        mv anykernel_temp/AnyKernel3-master anykernel
        rm -rf anykernel_temp anykernel.zip

        cp out/arch/arm64/boot/Image anykernel/

        cat > anykernel/anykernel.sh << 'EOF'
        #!/system/bin/sh
        # AnyKernel3 Ramdisk Mod Script

        properties() {
        kernel.string=Atlas-GKI-Kernel
        do.devicecheck=1
        do.modules=0
        do.systemless=1
        do.cleanup=1
        do.cleanuponabort=0
        device.name1=a13
        device.name2=a135f
        device.name3=exynos850
        }

        block=/dev/block/by-name/boot;
        is_slot_device=0;
        ramdisk_compression=auto;

        . tools/ak3-core.sh;

        dump_boot;
        write_boot;
        EOF

        chmod +x anykernel/anykernel.sh
        cd anykernel
        zip -r9 ../Atlas-GKI-Kernel-$(date +%Y%m%d).zip .

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: |
          kernel/out/arch/arm64/boot/Image
          kernel/Atlas-GKI-Kernel-*.zip

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          kernel/build.log
          kernel/build_single.log
          kernel/out/.config
