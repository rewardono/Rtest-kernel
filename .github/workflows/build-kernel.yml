name: Build GKI Kernel for Samsung A135F - COMPLETE FINAL
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      # STEP 1: Clean install
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            wget \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu

      # STEP 2: Create SIMPLE ccache wrapper
      - name: Create CCACHE Wrapper
        run: |
          # Create a simple passthrough ccache
          sudo bash -c 'cat > /usr/bin/ccache << "EOF"
          #!/bin/bash
          # Simple passthrough to the real compiler
          # Remove "ccache" from args if present
          new_args=()
          for arg in "$@"; do
              [[ $arg != "ccache" ]] && new_args+=("$arg")
          done
          
          # Execute with filtered args
          exec "${new_args[@]}"
          EOF'
          
          sudo chmod +x /usr/bin/ccache
          
          # Test it
          echo "Testing ccache wrapper..."
          /usr/bin/ccache gcc --version >/dev/null && echo "âœ… CCACHE wrapper working"

      # STEP 3: Fresh kernel
      - name: Get Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1

      # STEP 4: NUCLEAR FIX for compiler flags
      - name: Fix Compiler Flags NUCLEAR
        run: |
          cd kernel
          
          echo "=== NUCLEAR FIX FOR COMPILER FLAGS ==="
          
          # 1. FIRST, fix the source files
          echo "Fixing source Makefiles..."
          find . -type f \( -name "Makefile*" -o -name "Kbuild*" -o -name "*.mk" \) -exec sed -i \
            -e 's/-Werror-Wreturn-type/-Werror -Wreturn-type/g' \
            -e 's/-Werror-Wimplicit-function-declaration/-Werror -Wimplicit-function-declaration/g' \
            -e 's/-Werror-implicit-function-declaration/-Werror -Wimplicit-function-declaration/g' \
            -e 's/-implicit-function-declaration/-Wimplicit-function-declaration/g' \
            -e 's/=return-type/-Wreturn-type/g' \
            {} \; 2>/dev/null || true
          
          # 2. Fix root Makefile HOSTCC
          sed -i 's/^HOSTCC\s*:=.*/HOSTCC = ccache gcc/' Makefile 2>/dev/null || true
          sed -i 's/^HOSTCXX\s*:=.*/HOSTCXX = ccache g++/' Makefile 2>/dev/null || true
          
          # 3. Fix scripts/Makefile.host
          if [ -f "scripts/Makefile.host" ]; then
            sed -i 's/^HOSTCC\s*:=.*/HOSTCC = ccache gcc/' scripts/Makefile.host
            sed -i 's/^HOSTCXX\s*:=.*/HOSTCXX = ccache g++/' scripts/Makefile.host
          fi
          
          # 4. Original unused variable fix
          sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c 2>/dev/null || true
          
          echo "âœ… Source files fixed"

      # STEP 5: Add KernelSU
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          
          wget -q https://github.com/tiann/KernelSU/archive/main.tar.gz -O ksu.tar.gz
          tar -xzf ksu.tar.gz
          mv KernelSU-main/kernel drivers/kernelsu
          
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          
          rm -rf KernelSU-main ksu.tar.gz

      # STEP 6: Configure with SIMPLE method
      - name: Configure Kernel
        run: |
          cd kernel
          
          rm -rf out 2>/dev/null || true
          make distclean 2>/dev/null || true
          
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export HOSTCC="ccache gcc"
          export HOSTCXX="ccache g++"
          
          mkdir -p out
          
          # Simple config
          make O=out ARCH=arm64 gki_defconfig
          
          # Add KernelSU
          echo "CONFIG_KSU=y" >> out/.config
          echo "CONFIG_MODULES=y" >> out/.config
          echo "# CONFIG_MODULE_SIG is not set" >> out/.config
          
          # Update config
          make O=out ARCH=arm64 olddefconfig

      # STEP 7: CRITICAL - Fix generated Makefile BEFORE building
      - name: Fix Generated Makefile BEFORE Build
        run: |
          cd kernel
          
          echo "=== FIXING GENERATED MAKEFILE ==="
          
          # This is CRITICAL - fix the generated Makefile in out/
          if [ -f "out/Makefile" ]; then
            echo "Patching out/Makefile..."
            
            # Fix the malformed flags in the generated Makefile
            sed -i \
              -e 's/-Werror-Wreturn-type/-Werror -Wreturn-type/g' \
              -e 's/-Werror-Wimplicit-function-declaration/-Werror -Wimplicit-function-declaration/g' \
              -e 's/-Werror-implicit-function-declaration/-Werror -Wimplicit-function-declaration/g' \
              out/Makefile
            
            # Check if fix worked
            echo "Checking for bad flags in generated Makefile:"
            grep -n "Werror-W" out/Makefile || echo "âœ… No bad flags found"
          fi
          
          # Also fix scripts/Makefile.build in out directory
          if [ -f "out/scripts/Makefile.build" ]; then
            echo "Patching out/scripts/Makefile.build..."
            sed -i 's/-Werror-Wreturn-type/-Werror -Wreturn-type/g' out/scripts/Makefile.build
          fi

      # STEP 8: BUILD with FLAG OVERRIDE
      - name: Build Kernel
        run: |
          cd kernel
          
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export HOSTCC="ccache gcc"
          export HOSTCXX="ccache g++"
          
          echo "ðŸš€ Building kernel with flag override..."
          
          # Build with KCFLAGS to override any remaining bad flags
          make O=out ARCH=arm64 KCFLAGS="-Wno-error -Wno-return-type -Wno-implicit-function-declaration" -j$(nproc) 2>&1 | tee build.log || {
            echo "âš ï¸ Build failed, checking error..."
            
            # Show the exact error
            if grep -q "unrecognized command-line option.*Werror-W" build.log; then
              echo "=== COMPILER FLAG ERROR STILL EXISTS ==="
              echo "The generated Makefile still has bad flags!"
              
              # Check generated Makefile
              if [ -f "out/Makefile" ]; then
                echo "Checking out/Makefile for bad flags:"
                grep -n "Werror-W" out/Makefile
              fi
              
              # Try building with single core to see exact error
              echo "Trying single-core build for debugging..."
              make O=out ARCH=arm64 clean 2>/dev/null || true
              make O=out ARCH=arm64 -j1 V=1 2>&1 | tee debug_build.log
              exit 1
            fi
          }
          
          # Check for kernel
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ KERNEL BUILT SUCCESSFULLY! ðŸŽ‰ðŸŽ‰ðŸŽ‰"
            ls -lh out/arch/arm64/boot/Image
          else
            echo "âŒ Kernel Image not found"
            exit 1
          fi

      # STEP 9: Create flashable package (FIXED syntax)
      - name: Create Flashable Package
        if: success()
        run: |
          cd kernel
          
          echo "ðŸ“¦ Creating flashable package..."
          
          mkdir -p anykernel
          cp out/arch/arm64/boot/Image anykernel/
          
          # Create the anykernel.sh script WITHOUT heredoc EOF issues
          echo '#!/system/bin/sh' > anykernel/anykernel.sh
          echo '' >> anykernel/anykernel.sh
          echo 'ui_print " "' >> anykernel/anykernel.sh
          echo 'ui_print "*******************************"' >> anykernel/anykernel.sh
          echo 'ui_print "* GKI Kernel for Samsung A135F"' >> anykernel/anykernel.sh
          echo 'ui_print "* With KernelSU Support"' >> anykernel/anykernel.sh
          echo 'ui_print "* Build Date: $(date +%Y-%m-%d)"' >> anykernel/anykernel.sh
          echo 'ui_print "*******************************"' >> anykernel/anykernel.sh
          echo 'ui_print " "' >> anykernel/anykernel.sh
          echo '' >> anykernel/anykernel.sh
          echo 'device=$(getprop ro.product.device)' >> anykernel/anykernel.sh
          echo 'model=$(getprop ro.product.model)' >> anykernel/anykernel.sh
          echo 'ui_print "- Device: $device"' >> anykernel/anykernel.sh
          echo 'ui_print "- Model: $model"' >> anykernel/anykernel.sh
          echo '' >> anykernel/anykernel.sh
          echo 'ui_print "- Backing up current kernel..."' >> anykernel/anykernel.sh
          echo 'dd if=/dev/block/by-name/boot of=/sdcard/boot_backup.img 2>/dev/null || true' >> anykernel/anykernel.sh
          echo '' >> anykernel/anykernel.sh
          echo 'ui_print "- Flashing new kernel..."' >> anykernel/anykernel.sh
          echo 'dd if=/tmp/anykernel/Image of=/dev/block/by-name/boot 2>/dev/null || true' >> anykernel/anykernel.sh
          echo '' >> anykernel/anykernel.sh
          echo 'ui_print "- Done!"' >> anykernel/anykernel.sh
          echo 'ui_print " "' >> anykernel/anykernel.sh
          
          chmod +x anykernel/anykernel.sh
          
          cd anykernel
          zip -r9 ../A135F-GKI-Kernel.zip *
          
          echo "âœ… Flashable package created: A135F-GKI-Kernel.zip"
          ls -lh ../A135F-GKI-Kernel.zip

      # STEP 10: Upload artifacts
      - name: Upload Kernel Files
        uses: actions/upload-artifact@v4
        with:
          name: A135F-Kernel-Complete
          path: |
            kernel/out/arch/arm64/boot/Image
            kernel/A135F-GKI-Kernel.zip
          retention-days: 7

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Logs-Complete
          path: |
            kernel/build.log
            kernel/debug_build.log
          retention-days: 3
