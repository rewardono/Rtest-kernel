name: Build Kernel - Complete Fixes v17
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    steps:
    - name: Setup Environment
      run: |
        sudo apt update
        sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev git wget gcc-aarch64-linux-gnu g++-aarch64-linux-gnu python3 ccache
        sudo ln -s /usr/bin/ccache /usr/local/bin/ccache || true
    - name: Get Kernel Source
      run: |
        rm -rf kernel
        git clone https://github.com/samsungexynos850/atlas kernel --depth=1
    - name: Apply Comprehensive Fixes
      run: |
        cd kernel
       
        echo "=== Applying all necessary fixes ==="
       
        # Remove sensorhub directory to avoid all sensor-related errors
        echo "Removing sensorhub directory..."
        rm -rf drivers/sensorhub 2>/dev/null || true
       
        # Remove or comment sensorhub include in Kconfig and Makefile
        sed -i '/sensorhub/d' drivers/Kconfig 2>/dev/null || true
        sed -i '/sensorhub/d' drivers/Makefile 2>/dev/null || true
       
        # Existing fixes (bpf_trace, sec_debug, EMS, etc.) ‚Äì kept unchanged from v16
        sed -i 's/static inline __printf(1, 0) int bpf_do_trace_printk/static __printf(1, 0) int bpf_do_trace_printk/' kernel/trace/bpf_trace.c 2>/dev/null || true
        sed -i 's/static inline __printf(1, 0)/static __noinline __printf(1, 0)/' kernel/trace/bpf_trace.c 2>/dev/null || true
        sed -i 's|#define secdbg_exin_get_unfz(.*).*|#define secdbg_exin_get_unfz(a) ("")|' include/linux/sec_debug.h 2>/dev/null || true
        # EMS fixes (unchanged)
        if [ -f "include/linux/ems.h" ]; then
          EMS_LINE=$(grep -n "lb_cfs_tasks" include/linux/ems.h | head -1 | cut -d: -f1)
          if [ ! -z "$EMS_LINE" ]; then
            sed -i "${EMS_LINE}s/.*/extern struct list_head *lb_cfs_tasks(struct rq *rq, int sse);/" include/linux/ems.h
          fi
        fi
        if [ -f "kernel/sched/ems/load_balance.c" ]; then
          sed -i 's/struct list_head \*lb_cfs_tasks(struct rq \*rq, struct sched_entity \*se)/struct list_head *lb_cfs_tasks(struct rq *rq, int sse)/' kernel/sched/ems/load_balance.c 2>/dev/null || true
        fi
        if [ -f "kernel/sched/fair.c" ]; then
          sed -i '/static inline struct list_head \*lb_cfs_tasks.*{ return \&rq->cfs_tasks; }/d' kernel/sched/fair.c 2>/dev/null || true
        fi
        # need_memory_boosting, compiler flags, process.c, systrace, watchdog, BTS, input_booster, ufshcd, ip_gre, xdp_umem, cpu_cooling ‚Äì all unchanged
        # (omitted here for brevity, copy exactly from your v16 workflow)
       
        # IMPROVED GPU CLOCK DUMMY FIX (stronger patterns + comment EXPORT_SYMBOL)
        echo "Applying improved fix for gpex_clock_dummy.c conflict..."
        DUMMY_FILE="drivers/gpu/arm/bv_r38p1/exynos/frontend/dummy/gpex_clock_dummy.c"
        if [ -f "$DUMMY_FILE" ]; then
          # Broad rename for both possible function names
          sed -i 's/\b__clk_is_enabled\b/gpex_dummy_clk_is_enabled/g' "$DUMMY_FILE"
          sed -i 's/\bclk_is_enabled\b/gpex_dummy_clk_is_enabled/g' "$DUMMY_FILE"
          # Comment out any EXPORT_SYMBOL to avoid CRC conflicts
          sed -i 's/EXPORT_SYMBOL.*/\/\/ &/' "$DUMMY_FILE"
          echo "Renamed conflicting clk functions and disabled exports in $DUMMY_FILE"
        else
          echo "Warning: gpex_clock_dummy.c not found at expected path ‚Äì will rely on config disable"
        fi
       
        echo "‚úÖ All fixes applied"
    - name: Add KernelSU
      run: |
        cd kernel
        rm -rf drivers/kernelsu
        git clone https://github.com/tiann/KernelSU ksu_tmp --depth=1
        mv ksu_tmp/kernel drivers/kernelsu
        echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
        echo 'obj-y += kernelsu/' >> drivers/Makefile
        rm -rf ksu_tmp
    - name: Configure Kernel
      run: |
        cd kernel
        rm -rf out
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
       
        mkdir -p out
        make O=out ARCH=arm64 gki_defconfig
       
        chmod +x scripts/config
       
        ./scripts/config --file out/.config --enable KSU
        ./scripts/config --file out/.config --set-str KSU_GIT_VERSION "github-action-build"
        ./scripts/config --file out/.config --disable MODULE_SIG
        ./scripts/config --file out/.config --disable MODULE_SIG_ALL
        ./scripts/config --file out/.config --disable MODULE_SIG_FORCE
       
        # Existing disables (BTS, watchdog extensions, input booster, EMS, Bluetooth, sensorhub, UFS, XDP, thermal, etc.) ‚Äì unchanged
       
        # NEW: Aggressively disable proprietary Mali/GPU driver for GKI (prevents dummy clock conflict entirely)
        echo "Disabling proprietary Mali/GPU driver options for GKI compatibility..."
        ./scripts/config --file out/.config --disable MALI_MIDGARD
        ./scripts/config --file out/.config --disable MALI_BIFROST
        ./scripts/config --file out/.config --disable MALI_VALHALL
        ./scripts/config --file out/.config --disable ARM_MALI_BIFROST
        ./scripts/config --file out/.config --disable MALI_EXYNOS
        ./scripts/config --file out/.config --disable MALI_PLATFORM_EXYNOS
        ./scripts/config --file out/.config --disable EXYNOS_MALI
        ./scripts/config --file out/.config --disable GPU_EXYNOS
        ./scripts/config --file out/.config --disable GPEX
        ./scripts/config --file out/.config --disable GPEX_CLOCK
       
        make O=out ARCH=arm64 olddefconfig
    - name: Build Kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export KCFLAGS="-w -Wno-error -Wno-error=attribute-alias -Wno-error=implicit-function-declaration -Wno-error=incompatible-pointer-types"
       
        echo "üöÄ Starting kernel build..."
       
        # (Rest of build step unchanged from v16 ‚Äì parallel ‚Üí single-core fallback ‚Üí emergency fixes ‚Üí final checks)
        # Keep all the emergency fixes (including the strengthened clock dummy one if needed)
       
        if [ -f "out/arch/arm64/boot/Image" ]; then
          echo "üéâüéâüéâ KERNEL BUILD SUCCESSFUL! üéâüéâüéâ"
          ls -lh out/arch/arm64/boot/Image
        else
          echo "‚ùå Kernel Image not found!"
          find out -name "Image*" | head -10
          exit 1
        fi
    - name: Create AnyKernel3 Package
      if: success()
      run: |
        # (Unchanged from v16)
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: |
          kernel/out/arch/arm64/boot/Image
          kernel/Atlas-GKI-Kernel-*.zip
    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          kernel/build.log
          kernel/build_single.log
          kernel/build_final.log
          kernel/out/.config
