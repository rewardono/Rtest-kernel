name: Build GKI Kernel for Samsung A135F - WORKING CACHE FINAL
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      # STEP 1: Install WITHOUT any cache tools
      - name: Install Dependencies (Clean)
        run: |
          sudo apt update
          # Remove ALL cache-related packages
          sudo apt remove --purge -y ccache cache 2>/dev/null || true
          sudo apt autoremove -y
          
          # Install fresh packages
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            wget \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu
          
          echo "âœ… Clean dependencies installed"

      # STEP 2: Create PROPER working ccache wrapper
      - name: Create Working CCACHE Wrapper
        run: |
          # Remove any existing ccache
          sudo rm -f /usr/bin/ccache /usr/local/bin/ccache 2>/dev/null || true
          
          # Create a PROPER ccache wrapper that actually works
          sudo bash -c 'cat > /usr/bin/ccache << "EOF"
          #!/bin/bash
          # This is a dummy ccache that just passes through to the real compiler
          
          # Get the real compiler name from arguments
          # Look for gcc, g++, or aarch64-linux-gnu-* patterns
          for arg in "$@"; do
              if [[ "$arg" == *gcc* ]] || [[ "$arg" == *g++* ]] || [[ "$arg" == aarch64-linux-gnu-* ]]; then
                  compiler="$arg"
                  break
              fi
          done
          
          # If no compiler found in args, use gcc as default for host compilation
          if [ -z "$compiler" ]; then
              if [[ "$1" == *.c ]]; then
                  compiler="gcc"
              elif [[ "$1" == *.cpp ]] || [[ "$1" == *.cc ]] || [[ "$1" == *.cxx ]]; then
                  compiler="g++"
              else
                  # Just pass through whatever was intended
                  exec "$@"
              fi
          fi
          
          # Execute the real compiler with all arguments
          exec $compiler "$@"
          EOF'
          
          sudo chmod +x /usr/bin/ccache
          
          # Verify it works
          echo "Testing ccache wrapper..."
          /usr/bin/ccache --version || echo "âœ… CCACHE wrapper created"
          
          # Also create symlink in /usr/local/bin
          sudo ln -sf /usr/bin/ccache /usr/local/bin/ccache 2>/dev/null || true

      # STEP 3: Fresh kernel source
      - name: Get Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
          echo "âœ… Kernel source cloned"

      # STEP 4: Apply ALL fixes at ONCE
      - name: Apply Comprehensive Fixes
        run: |
          cd kernel
          
          echo "=== APPLYING COMPREHENSIVE FIXES ==="
          
          # 1. Fix the compiler flag error (main issue)
          echo "Fixing compiler flags..."
          
          # Create a fix script
          cat > fix_all.sh << 'EOF'
          #!/bin/bash
          
          echo "Searching for and fixing malformed compiler flags..."
          
          # Find all Makefiles and fix the specific patterns
          find . -type f \( -name "Makefile*" -o -name "Kbuild*" -o -name "*.mk" \) | while read file; do
              # Backup original
              cp "$file" "$file.bak" 2>/dev/null || true
              
              # Fix patterns
              sed -i \
                  -e 's/-Werror-Wreturn-type/-Werror -Wreturn-type/g' \
                  -e 's/-Werror-Wimplicit-function-declaration/-Werror -Wimplicit-function-declaration/g' \
                  -e 's/-Werror-implicit-function-declaration/-Werror -Wimplicit-function-declaration/g' \
                  -e 's/-implicit-function-declaration/-Wimplicit-function-declaration/g' \
                  -e 's/=return-type/-Wreturn-type/g' \
                  -e 's/\bccache\b//g' \
                  "$file" 2>/dev/null || true
          done
          
          # Specifically fix root Makefile
          if [ -f "Makefile" ]; then
              echo "Fixing root Makefile..."
              sed -i 's/^HOSTCC\s*:=.*/HOSTCC = gcc/' Makefile
              sed -i 's/^HOSTCXX\s*:=.*/HOSTCXX = g++/' Makefile
          fi
          
          # Fix scripts/Makefile.host
          if [ -f "scripts/Makefile.host" ]; then
              echo "Fixing scripts/Makefile.host..."
              sed -i 's/^HOSTCC\s*:=.*/HOSTCC = gcc/' scripts/Makefile.host
              sed -i 's/^HOSTCXX\s*:=.*/HOSTCXX = g++/' scripts/Makefile.host
          fi
          
          # Original fix for unused variable
          if [ -f "kernel/power/process.c" ]; then
              sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c
          fi
          
          echo "âœ… Fixes applied"
          EOF
          
          chmod +x fix_all.sh
          ./fix_all.sh
          
          echo "=== VERIFICATION ==="
          echo "Checking for remaining bad flags..."
          ! grep -r "-Werror-Wreturn-type\|-Werror-Wimplicit-function-declaration\|-Werror-implicit-function-declaration" . --include="Makefile*" --include="Kbuild*" 2>/dev/null && echo "âœ… No bad flags found"

      # STEP 5: Add KernelSU
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          
          wget -q https://github.com/tiann/KernelSU/archive/main.tar.gz -O ksu.tar.gz
          tar -xzf ksu.tar.gz
          mv KernelSU-main/kernel drivers/kernelsu
          
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          
          rm -rf KernelSU-main ksu.tar.gz
          echo "âœ… KernelSU added"

      # STEP 6: Configure with WORKING ccache
      - name: Configure Kernel
        run: |
          cd kernel
          
          # NUCLEAR CLEAN
          rm -rf out 2>/dev/null || true
          make distclean 2>/dev/null || true
          rm -f .config .config.old .config.bak
          
          # Set environment WITH ccache in PATH
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export HOSTCC="ccache gcc"  # Use our wrapper!
          export HOSTCXX="ccache g++"
          
          # Make sure ccache is in PATH
          export PATH="/usr/bin:$PATH"
          
          mkdir -p out
          
          echo "=== CONFIGURATION STEP 1 ==="
          make O=out ARCH=arm64 gki_defconfig 2>&1 | tee config1.log
          
          # Enable KernelSU
          echo "CONFIG_KSU=y" >> out/.config
          echo "CONFIG_MODULES=y" >> out/.config
          echo "# CONFIG_MODULE_SIG is not set" >> out/.config
          
          echo "=== CONFIGURATION STEP 2 ==="
          make O=out ARCH=arm64 olddefconfig 2>&1 | tee config2.log
          
          echo "âœ… Configuration complete"

      # STEP 7: BUILD with simplified approach
      - name: Build Kernel
        run: |
          cd kernel
          
          # Use ccache wrapper for build
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export HOSTCC="ccache gcc"
          export HOSTCXX="ccache g++"
          export PATH="/usr/bin:$PATH"
          
          echo "ğŸš€ Starting kernel build..."
          
          # Simple direct build
          if make O=out ARCH=arm64 -j$(nproc) 2>&1 | tee build.log; then
            echo "âœ… Build successful!"
          else
            echo "âš ï¸ Parallel build failed, trying single core..."
            
            # Clean and try single core
            make O=out ARCH=arm64 clean 2>/dev/null || true
            
            if make O=out ARCH=arm64 -j1 2>&1 | tee build_single.log; then
              echo "âœ… Single-core build successful!"
            else
              echo "âŒ Build failed"
              echo "=== LAST ERRORS ==="
              tail -100 build_single.log
              
              # Check for specific errors
              if grep -q "unrecognized command-line option" build_single.log; then
                echo "=== COMPILER FLAG ERROR DETECTED ==="
                echo "The flag fix didn't work. Checking generated Makefile..."
                if [ -f "out/Makefile" ]; then
                  grep -n "Werror-W" out/Makefile | head -5
                fi
              fi
              exit 1
            fi
          fi
          
          # Verify kernel
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "ğŸ‰ğŸ‰ğŸ‰ KERNEL BUILD SUCCESSFUL! ğŸ‰ğŸ‰ğŸ‰"
            ls -lh out/arch/arm64/boot/Image
            file out/arch/arm64/boot/Image
          else
            echo "âŒ Kernel Image not found!"
            find out/arch/arm64/b
