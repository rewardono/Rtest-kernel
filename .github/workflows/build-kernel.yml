name: Build GKI Kernel for A135F
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            git \
            ccache \
            wget \
            unzip \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            clang \
            llvm \
            lld
      
      - name: Get Kernel Source
        run: |
          rm -rf kernel
          git clone https://github.com/samsungexynos850/atlas kernel --depth=1
      
      - name: Add KernelSU
        run: |
          cd kernel
          rm -rf drivers/kernelsu
          wget -q https://github.com/tiann/KernelSU/archive/refs/heads/main.zip -O ksu.zip
          unzip -q ksu.zip
          mv KernelSU-main/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          rm -rf KernelSU-main ksu.zip
      
      - name: Fix Compilation Issue
        run: |
          cd kernel
          # Fix the unused variable warning in kernel/power/process.c
          # Option 1: Comment out the unused variable
          sed -i '49s/const char \*sys_state/\/\/ const char \*sys_state/' kernel/power/process.c
          
          # Option 2: Mark it as unused
          # sed -i '49s/const char \*sys_state/const char __maybe_unused \*sys_state/' kernel/power/process.c
          
          # Also try to disable Werror for this specific file
          echo 'CFLAGS_process.o := -Wno-error' >> kernel/power/Makefile
      
      - name: Build Kernel with CLANG
        run: |
          cd kernel
          
          # Clean any previous builds
          make distclean 2>/dev/null || true
          
          # Use CLANG - it's often more lenient with warnings
          export ARCH=arm64
          export LLVM=1
          export LLVM_IAS=1
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Configure
          make gki_defconfig
          
          # Enable KSU
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
          
          # Disable module signing
          sed -i 's/CONFIG_MODULE_SIG=y/# CONFIG_MODULE_SIG is not set/' .config 2>/dev/null || true
          
          # Build with CLANG
          echo "Building with CLANG..."
          make CC=clang LD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip -j$(nproc) 2>&1 | tee build.log
          
          # Check if build succeeded
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "✓ Build successful!"
            cp arch/arm64/boot/Image kernel-Image
            exit 0
          fi
          
          echo "CLANG build failed, trying GCC with specific flags..."
          
          # Try GCC with specific flags to disable the warning
          make distclean 2>/dev/null || true
          make gki_defconfig
          sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' .config
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config
          
          # Build with GCC but disable the specific warning
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export KCFLAGS="-Wno-unused-variable -Wno-error=unused-variable"
          
          make -j$(nproc) 2>&1 | tee build_gcc.log
          
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "✓ GCC build successful!"
            cp arch/arm64/boot/Image kernel-Image
          else
            echo "✗ Both builds failed"
            echo "=== Last errors from CLANG build ==="
            tail -50 build.log | grep -i "error\|fail" || true
            echo "=== Last errors from GCC build ==="
            tail -50 build_gcc.log | grep -i "error\|fail" || true
            exit 1
          fi
      
      - name: Prepare Artifacts
        run: |
          cd kernel
          
          if [ -f "kernel-Image" ]; then
            echo "✓ Kernel Image created successfully!"
            echo "File size: $(du -h kernel-Image | cut -f1)"
            
            mkdir -p artifacts
            cp kernel-Image artifacts/
            
            # Create compressed version too
            gzip -k -f kernel-Image
            cp kernel-Image.gz artifacts/ 2>/dev/null || true
            
            echo "Artifacts ready:"
            ls -lh artifacts/
          else
            echo "✗ No kernel Image found"
            echo "Checking build directory..."
            find . -name "Image" -type f | head -5
            exit 1
          fi
      
      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: A135F-GKI-Kernel
          path: kernel/artifacts/
          retention-days: 7
