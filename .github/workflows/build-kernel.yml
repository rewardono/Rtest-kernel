name: Build Kernel - SIMPLE FIXED
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Setup
      run: |
        sudo apt update
        sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev git wget gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        # Create simple ccache
        echo '#!/bin/bash' | sudo tee /usr/local/bin/ccache
        echo 'exec "${@}"' | sudo tee -a /usr/local/bin/ccache
        sudo chmod +x /usr/local/bin/ccache
    
    - name: Get Kernel
      run: |
        rm -rf kernel
        git clone https://github.com/samsungexynos850/atlas kernel --depth=1
    
    - name: Fix Files
      run: |
        cd kernel
        
        # Fix sec_debug.h
        sed -i 's/#define secdbg_exin_get_unfz(a).*/#define secdbg_exin_get_unfz(a) ("")/' include/linux/sec_debug.h 2>/dev/null || true
        
        # Fix process.c
        sed -i '49s/const char \*sys_state\[SYSTEM_END\] = {/const char __maybe_unused \*sys_state\[SYSTEM_END\] = {/' kernel/power/process.c 2>/dev/null || true
        
        # Remove ccache from Makefiles
        sed -i 's/ccache//g' Makefile 2>/dev/null || true
        if [ -f "scripts/Makefile.host" ]; then
          sed -i 's/ccache//g' scripts/Makefile.host
          sed -i 's/^HOSTCC.*/HOSTCC = gcc/' scripts/Makefile.host
        fi
    
    - name: Add KernelSU
      run: |
        cd kernel
        rm -rf drivers/kernelsu 2>/dev/null || true
        wget -q https://github.com/tiann/KernelSU/archive/main.tar.gz
        tar -xzf main.tar.gz
        mv KernelSU-main/kernel drivers/kernelsu
        echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
        echo 'obj-y += kernelsu/' >> drivers/Makefile
        rm -rf KernelSU-main main.tar.gz
    
    - name: Configure
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export HOSTCC=gcc
        mkdir -p out
        make O=out gki_defconfig
        echo "CONFIG_KSU=y" >> out/.config
        echo "CONFIG_MODULES=y" >> out/.config
        make O=out olddefconfig
    
    - name: Build
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export HOSTCC=gcc
        make O=out -j$(nproc) || make O=out -j1
        ls -la out/arch/arm64/boot/ 2>/dev/null || true
    
    - name: Upload
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: kernel
        path: kernel/out/arch/arm64/boot/Image
